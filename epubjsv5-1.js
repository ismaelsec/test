/**
 * @license Epub.js v0.5.0-alpha.2 | BSD-2-Clause | https://github.com/futurepress/epub.js
 */ let{apply:t,call:e}=Function.prototype,{create:i,defineProperty:s,defineProperties:n}=Object,hasOwnProperty=Object.prototype.hasOwnProperty,descriptor={configurable:!0,enumerable:!1,writable:!0},on=function(t,e){let n;return hasOwnProperty.call(this,"__ee__")?n=this.__ee__:(n=descriptor.value=i(null),s(this,"__ee__",descriptor),descriptor.value=null),n[t]?"object"==typeof n[t]?n[t].push(e):n[t]=[n[t],e]:n[t]=e,this},once=function(e,i){let s,n;return n=this,on.call(this,e,s=function(){off.call(n,e,s),t.call(i,this,arguments)}),s.__eeOnceListener__=i,this},off=function(t,e){let i,s,n,r;if(!hasOwnProperty.call(this,"__ee__")||!(i=this.__ee__)[t])return this;if("object"==typeof(s=i[t]))for(r=0;n=s[r];++r)(n===e||n.__eeOnceListener__===e)&&(2===s.length?i[t]=s[r?0:1]:s.splice(r,1));else(s===e||s.__eeOnceListener__===e)&&delete i[t];return this},emit=function(i){let s,n,r,o,a;if(hasOwnProperty.call(this,"__ee__")&&(o=this.__ee__[i])){if("object"==typeof o){for(s=1,n=arguments.length,a=Array(n-1);s<n;++s)a[s-1]=arguments[s];for(s=0,o=o.slice();r=o[s];++s)t.call(r,this,a)}else switch(arguments.length){case 1:e.call(o,this);break;case 2:e.call(o,this,arguments[1]);break;case 3:e.call(o,this,arguments[1],arguments[2]);break;default:for(s=1,n=arguments.length,a=Array(n-1);s<n;++s)a[s-1]=arguments[s];t.call(o,this,a)}}},descriptors={on:{value:on,configurable:!0,enumerable:!1,writable:!0},once:{value:once,configurable:!0,enumerable:!1,writable:!0},off:{value:off,configurable:!0,enumerable:!1,writable:!0},emit:{value:emit,configurable:!0,enumerable:!1,writable:!0}},base=n({},descriptors);function EventEmitter(t){return null==t?i(base):n(Object(t),descriptors)}function isAbsolute(t){return t?t instanceof URL||t.indexOf("://")>-1:void 0}function createUrl(t,e){if(t instanceof URL)return t;if(e||isAbsolute(t))return new URL(t,e);{let i="";return i="undefined"!=typeof window&&void 0!==window.location?window.location.href:"http://example.com",new URL(t,i)}}function filename(t){let e=createUrl(t);return e.pathname.split("/").pop()}function directory(t){let e=createUrl(t),i=filename(e);return e.pathname.replace(i,"")}function extension(t){let e=filename(t);return e.split(".").pop()}function resolve(t,e){let i=createUrl(t);return"http://example.com"===i.origin?new URL(e,i).href.replace("http://example.com/",""):new URL(e,i).href}function relative(t,e){let i=createUrl(t);return new URL(e,i).pathname}var url=Object.freeze({__proto__:null,isAbsolute:isAbsolute,createUrl:createUrl,filename:filename,directory:directory,extension:extension,resolve:resolve,relative:relative});let EPUBJS_VERSION="0.4",DOM_EVENTS=["keydown","keyup","keypressed","mouseup","mousedown","click","touchend","touchstart"],EVENTS={BOOK:{OPEN_FAILED:"openFailed",READY:"ready"},CONTENTS:{EXPAND:"expand",RESIZE:"resize",SELECTED:"selected",SELECTED_RANGE:"selectedRange",LINK_CLICKED:"linkClicked"},LOCATIONS:{CHANGED:"changed"},MANAGERS:{RESIZE:"resize",RESIZED:"resized",ORIENTATION_CHANGE:"orientationchange",ADDED:"added",SCROLL:"scroll",SCROLLED:"scrolled"},VIEWS:{AXIS:"axis",LOAD_ERROR:"loaderror",RENDERED:"rendered",RESIZED:"resized",DISPLAYED:"displayed",SHOWN:"shown",HIDDEN:"hidden",MARK_CLICKED:"markClicked"},RENDITION:{STARTED:"started",ATTACHED:"attached",DISPLAYED:"displayed",DISPLAY_ERROR:"displayerror",RENDERED:"rendered",REMOVED:"removed",RESIZED:"resized",ORIENTATION_CHANGE:"orientationchange",LOCATION_CHANGED:"locationChanged",RELOCATED:"relocated",MARK_CLICKED:"markClicked",SELECTED:"selected",LAYOUT:"layout",WORKER_FAILED:"workerFailed",WORKER_INACTIVE:"workerInactive"},LAYOUT:{UPDATED:"updated"}},XML_NS="http://www.w3.org/1999/xhtml",requestAnimationFrame$1="undefined"!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame),ELEMENT_NODE$2=1,TEXT_NODE$1=3,COMMENT_NODE=8,DOCUMENT_NODE$1=9;function uuid(){var t=new Date().getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)})}function documentHeight(){return Math.max(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)}function isElement(t){return!!(t&&1==t.nodeType)}function isNumber(t){return!isNaN(parseFloat(t))&&isFinite(t)}function isFloat(t){let e=parseFloat(t);return!1!==isNumber(t)&&(!!("string"==typeof t&&t.indexOf(".")>-1)||Math.floor(e)!==e)}function prefixed(t){var e=["Webkit","webkit","Moz","O","ms"],i=["-webkit-","-webkit-","-moz-","-o-","-ms-"],s=t[0].toUpperCase()+t.slice(1),n=e.length;if("undefined"==typeof document||void 0!==document.body.style[t])return t;for(var r=0;r<n;r++)if(void 0!==document.body.style[e[r]+s])return i[r]+t;return t}function defaults(t){for(var e=1,i=arguments.length;e<i;e++){var s=arguments[e];for(var n in s)void 0===t[n]&&(t[n]=s[n])}return t}function extend(t){var e=[].slice.call(arguments,1);return e.forEach(function(e){e&&Object.getOwnPropertyNames(e).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))})}),t}function insert(t,e,i){var s=locationOf(t,e,i);return e.splice(s,0,t),s}function locationOf(t,e,i,s,n){var r,o=s||0,a=n||e.length,h=parseInt(o+(a-o)/2);return(i||(i=function(t,e){return t>e?1:t<e?-1:t==e?0:void 0}),a-o<=0)?h:(r=i(e[h],t),a-o==1)?r>=0?h:h+1:0===r?h:-1===r?locationOf(t,e,i,h,a):locationOf(t,e,i,o,h)}function indexOfSorted$1(t,e,i,s,n){var r,o=s||0,a=n||e.length,h=parseInt(o+(a-o)/2);return(i||(i=function(t,e){return t>e?1:t<e?-1:t==e?0:void 0}),a-o<=0)?-1:(r=i(e[h],t),a-o==1)?0===r?h:-1:0===r?h:-1===r?indexOfSorted$1(t,e,i,h,a):indexOfSorted$1(t,e,i,o,h)}function bounds(t){var e=window.getComputedStyle(t),i=0,s=0;return["width","paddingRight","paddingLeft","marginRight","marginLeft","borderRightWidth","borderLeftWidth"].forEach(function(t){i+=parseFloat(e[t])||0}),["height","paddingTop","paddingBottom","marginTop","marginBottom","borderTopWidth","borderBottomWidth"].forEach(function(t){s+=parseFloat(e[t])||0}),{height:s,width:i}}function borders(t){var e=window.getComputedStyle(t),i=0,s=0;return["paddingRight","paddingLeft","marginRight","marginLeft","borderRightWidth","borderLeftWidth"].forEach(function(t){i+=parseFloat(e[t])||0}),["paddingTop","paddingBottom","marginTop","marginBottom","borderTopWidth","borderBottomWidth"].forEach(function(t){s+=parseFloat(e[t])||0}),{height:s,width:i}}function nodeBounds(t){let e,i=t.ownerDocument;if(t.nodeType==Node.TEXT_NODE){let s=i.createRange();s.selectNodeContents(t),e=s.getBoundingClientRect()}else e=t.getBoundingClientRect();return e}function windowBounds(){var t=window.innerWidth,e=window.innerHeight;return{top:0,left:0,right:t,bottom:e,width:t,height:e}}function indexOfNode(t,e){for(var i,s=t.parentNode.childNodes,n=-1,r=0;r<s.length&&((i=s[r]).nodeType===e&&n++,i!=t);r++);return n}function indexOfTextNode(t){return indexOfNode(t,3)}function indexOfElementNode(t){return indexOfNode(t,1)}function isXml(t){return["xml","opf","ncx"].indexOf(t)>-1}function createBlob(t,e){return new Blob([t],{type:e})}function createBlobUrl(t,e){var i,s=createBlob(t,e);return URL.createObjectURL(s)}function revokeBlobUrl(t){return URL.revokeObjectURL(t)}function createBase64Url(t,e){var i,s;if("string"==typeof t)return"data:"+e+";base64,"+(i=btoa(encodeURIComponent(t)))}function type(t){return Object.prototype.toString.call(t).slice(8,-1)}function parse$1(t,e,i){let s,n=i||DOMParser;return 65279===t.charCodeAt(0)&&(t=t.slice(1)),s=new n().parseFromString(t,e)}function qs(t,e){var i;if(!t)throw Error("No Element Provided");return void 0!==t.querySelector?t.querySelector(e):(i=t.getElementsByTagName(e)).length?i[0]:void 0}function qsa(t,e){return void 0!==t.querySelector?t.querySelectorAll(e):t.getElementsByTagName(e)}function qsp(t,e,i){var s,n;if(void 0!==t.querySelector){for(var r in e+="[",i)e+=r+"~='"+i[r]+"'";return e+="]",t.querySelector(e)}if(s=t.getElementsByTagName(e),n=Array.prototype.slice.call(s,0).filter(function(t){for(var e in i)if(t.getAttribute(e)===i[e])return!0;return!1}))return n[0]}function sprint(t,e){void 0!==(t.ownerDocument||t).createTreeWalker?treeWalker(t,e,NodeFilter.SHOW_TEXT):walk(t,function(t){t&&3===t.nodeType&&e(t)})}function treeWalker(t,e,i){var s=document.createTreeWalker(t,i,null,!1);let n;for(;n=s.nextNode();)e(n)}function walk(t,e){if(e(t))return!0;if(t=t.firstChild)do{if(walk(t,e))return!0;t=t.nextSibling}while(t)}function blob2base64(t){return new Promise(function(e,i){var s=new FileReader;s.readAsDataURL(t),s.onloadend=function(){e(s.result)}})}function defer(){this.resolve=null,this.reject=null,this.id=uuid(),this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e}),Object.freeze(this)}function querySelectorByType(t,e,i){var s;if(void 0!==t.querySelector&&(s=t.querySelector(`${e}[*|type="${i}"]`)),s&&0!==s.length)return s;s=qsa(t,e);for(var n=0;n<s.length;n++)if(s[n].getAttributeNS("http://www.idpf.org/2007/ops","type")===i||s[n].getAttribute("epub:type")===i)return s[n]}function findChildren(t){for(var e=[],i=t.childNodes,s=0;s<i.length;s++){let n=i[s];1===n.nodeType&&e.push(n)}return e}function parents(t){for(var e=[t];t;t=t.parentNode)e.unshift(t);return e}function filterChildren(t,e,i){for(var s=[],n=t.childNodes,r=0;r<n.length;r++){let o=n[r];if(1===o.nodeType&&o.nodeName.toLowerCase()===e){if(i)return o;s.push(o)}}if(!i)return s}function getParentByTagName(t,e){let i;if(null!==t&&""!==e)for(i=t.parentNode;1===i.nodeType;){if(i.tagName.toLowerCase()===e)return i;i=i.parentNode}}function nextSection(t,e){let i=t.index;if(i<e.length-1)return e.get(i+1)}function prevSection(t,e){let i=t.index;if(i>0)return e.get(i-1)}function serialize(t){let e=("undefined"!=typeof navigator&&navigator.userAgent||"").indexOf("Trident")>=0,i;return"undefined"==typeof XMLSerializer||e||(i=XMLSerializer),new i().serializeToString(t)}class RangeObject{constructor(){this.collapsed=!1,this.commonAncestorContainer=void 0,this.endContainer=void 0,this.endOffset=void 0,this.startContainer=void 0,this.startOffset=void 0}setStart(t,e){this.startContainer=t,this.startOffset=e,this.endContainer?this.commonAncestorContainer=this._commonAncestorContainer():this.collapse(!0),this._checkCollapsed()}setEnd(t,e){this.endContainer=t,this.endOffset=e,this.startContainer?(this.collapsed=!1,this.commonAncestorContainer=this._commonAncestorContainer()):this.collapse(!1),this._checkCollapsed()}collapse(t){this.collapsed=!0,t?(this.endContainer=this.startContainer,this.endOffset=this.startOffset,this.commonAncestorContainer=this.startContainer.parentNode):(this.startContainer=this.endContainer,this.startOffset=this.endOffset,this.commonAncestorContainer=this.endOffset.parentNode)}selectNode(t){let e=t.parentNode,i=Array.prototype.indexOf.call(e.childNodes,t);this.setStart(e,i),this.setEnd(e,i+1)}selectNodeContents(t){let e=3===t.nodeType?t.textContent.length:parent.childNodes.length;this.setStart(t,0),this.setEnd(t,e)}_commonAncestorContainer(t,e){var i=parents(t||this.startContainer),s=parents(e||this.endContainer);if(i[0]==s[0]){for(var n=0;n<i.length;n++)if(i[n]!=s[n])return i[n-1]}}_checkCollapsed(){this.startContainer===this.endContainer&&this.startOffset===this.endOffset?this.collapsed=!0:this.collapsed=!1}toString(){}}function debounce(t,e=300){let i;return(...s)=>{clearTimeout(i),i=setTimeout(()=>{t.apply(this,s)},e)}}function throttle(t,e=300,i={}){let s,n=null,r=0;return(...o)=>{let a=Date.now();r||!1!==i.leading||(r=a);let h=e-(a-r);return h<=0||h>e?(n&&(clearTimeout(n),n=null),r=a,s=t.apply(this,o)):n||!1===i.trailing||(n=setTimeout(()=>{r=!1===i.leading?0:Date.now(),n=null,s=t.apply(this,o)},h)),s}}function isXMLDocument(t){return t&&t.documentElement.getAttribute("xmlns")===XML_NS}var core=Object.freeze({__proto__:null,requestAnimationFrame:requestAnimationFrame$1,ELEMENT_NODE:1,TEXT_NODE:3,COMMENT_NODE:8,DOCUMENT_NODE:9,uuid:uuid,documentHeight:documentHeight,isElement:isElement,isNumber:isNumber,isFloat:isFloat,prefixed:prefixed,defaults:defaults,extend:extend,insert:insert,locationOf:locationOf,indexOfSorted:indexOfSorted$1,bounds:bounds,borders:borders,nodeBounds:nodeBounds,windowBounds:windowBounds,indexOfNode:indexOfNode,indexOfTextNode:indexOfTextNode,indexOfElementNode:indexOfElementNode,isXml:isXml,createBlob:createBlob,createBlobUrl:createBlobUrl,revokeBlobUrl:revokeBlobUrl,createBase64Url:createBase64Url,type:type,parse:parse$1,qs:qs,qsa:qsa,qsp:qsp,sprint:sprint,treeWalker:treeWalker,walk:walk,blob2base64:blob2base64,defer:defer,querySelectorByType:querySelectorByType,findChildren:findChildren,parents:parents,filterChildren:filterChildren,getParentByTagName:getParentByTagName,nextSection:nextSection,prevSection:prevSection,serialize:serialize,RangeObject:RangeObject,debounce:debounce,throttle:throttle,isXMLDocument:isXMLDocument});class ResourceList extends Map{constructor(t){super(t),this.order=Array.from(this.entries()),this.ids=new Map}add(t){let{url:e}=t;return this.set(e,t),t.id&&this.ids.set(t.id,e),this.size}append(t){let{url:e}=t,i=this.size;return t.index=i,this.order.push(e),this.set(e,t),t.id&&this.ids.set(t.id,e),i}prepend(t){let{url:e}=t;t.index=0,this.order.unshift(e),t.id&&this.ids.set(t.id,e);let i=new Map(this);this.clear(),this.set(e,t);let s=1;return i.forEach((t,e)=>{t.index=s,this.set(e,t),s++}),0}insert(t,e){let{url:i}=t;if(t.index=e,t.id&&this.ids.set(t.id,i),e>-1){this.order.splice(e,1);let s=new Map(this);this.clear();let n=0;s.forEach((s,r)=>{e===n&&(this.set(i,t),n++),e<n&&(s.index=n,this.set(r,s)),n++})}}delete(t){let{url:e}=t;super.delete(t),t.id&&this.ids.delete(t.id);let i=this.order.indexOf(e);if(i>-1){this.order.splice(i,1);let s=0;this.forEach((t,e)=>{t.index=s,s++})}}get(t){if(isNumber(t)){let e=t>-1&&t<this.order.length&&this.order[t];if(e)return this.get(e)}return super.get(t)}id(t){let e=this.ids.get(t);if(e)return this.get(e)}first(){let t=this.order.length&&this.order[0];if(t)return this.get(t)}last(){let t=this.order.length&&this.order[this.order.length-1];if(t)return this.get(t)}find(t){if(t){for(let[e,i]of this)if(t(i))return i}}map(t){let e=[];if(t){for(let[i,s]of this){let n=t(s);n&&e.push(n)}return e}}get length(){return this.size}toArray(){return Array.from(this.values())}toJSON(){return this.toArray()}}function request(t,e,i={}){let s={method:"GET",headers:i.headers,credentials:i.credentials};return e||(e=extension(t)),fetch(t,s).then(function(t){let e=new defer;return t.ok?t:403===t.status?(e.reject({status:this.response.status,response:this.response.response,message:"Forbidden",stack:Error().stack}),e.promise):(e.reject({status:t.status,message:"Empty Response",stack:Error().stack}),e.promise)}).then(function(t){if(isXml(e)||"xhtml"==e)return t.text();if("html"==e||"htm"==e)return t.text();if("json"==e)return t.json();if("blob"==e)return t.blob();else if("binary"==e)return t.arrayBuffer();else return t.text()}).then(function(t){let i;return isXml(e)?i=parse$1(t,"text/xml"):"xhtml"===e?i=parse$1(t,"application/xhtml+xml"):"html"===e||"htm"===e?i=parse$1(t,"text/html"):i=t,i})}let ELEMENT_NODE$1=1,TEXT_NODE=3,DOCUMENT_NODE=9;class EpubCFI{constructor(t,e,i){var s;if(this.str="",this.base={},this.spinePos=0,this.range=!1,this.path={},this.start=null,this.end=null,!(this instanceof EpubCFI))return new EpubCFI(t,e,i);if("string"==typeof e?this.base=this.parseComponent(e):"object"==typeof e&&e.steps&&(this.base=e),"string"===(s=this.checkType(t)))return this.str=t,extend(this,this.parse(t));if("range"===s)return extend(this,this.fromRange(t,this.base,i));if("node"===s)return extend(this,this.fromNode(t,this.base,i));else if("EpubCFI"===s&&t.path)return t;else if(!t)return this;else throw TypeError("not a valid argument for EpubCFI")}checkType(t){return this.isCfiString(t)?"string":t&&"object"==typeof t&&("Range"===type(t)||void 0!==t.startContainer)?"range":t&&"object"==typeof t&&void 0!==t.nodeType?"node":!!t&&"object"==typeof t&&t instanceof EpubCFI&&"EpubCFI"}parse(t){var e,i,s,n={spinePos:-1,range:!1,base:{},path:{},start:null,end:null};return"string"!=typeof t?{spinePos:-1}:(0===t.indexOf("epubcfi(")&&")"===t[t.length-1]&&(t=t.slice(8,t.length-1)),e=this.getChapterComponent(t))?(n.base=this.parseComponent(e),i=this.getPathComponent(t),n.path=this.parseComponent(i),(s=this.getRange(t))&&(n.range=!0,n.start=this.parseComponent(s[0]),n.end=this.parseComponent(s[1])),!n.base.steps||n.base.steps.length<2)?{spinePos:-1}:(n.spinePos=n.base.steps[1].index,n):{spinePos:-1}}parseComponent(t){var e,i={steps:[],terminal:{offset:null,assertion:null}},s=t.split(":"),n=s[0].split("/");return s.length>1&&(e=s[1],i.terminal=this.parseTerminal(e)),""===n[0]&&n.shift(),i.steps=n.map((function(t){return this.parseStep(t)}).bind(this)),i}parseStep(t){var e,i,s,n,r;if((n=t.match(/\[(.*)\]/))&&n[1]&&(r=n[1]),!isNaN(i=parseInt(t)))return i%2==0?(e="element",s=i/2-1):(e="text",s=(i-1)/2),{type:e,index:s,id:r||null}}parseTerminal(t){var e,i,s=t.match(/\[(.*)\]/);return s&&s[1]?(e=parseInt(t.split("[")[0]),i=s[1]):e=parseInt(t),isNumber(e)||(e=null),{offset:e,assertion:i}}getChapterComponent(t){return t.split("!")[0]}getPathComponent(t){var e=t.split("!");if(e[1])return e[1].split(",")[0]}getRange(t){var e=t.split(",");return 3===e.length&&[e[1],e[2]]}getCharecterOffsetComponent(t){return t.split(":")[1]||""}joinSteps(t){return t?t.map(function(t){var e="";return"element"===t.type&&(e+=(t.index+1)*2),"text"===t.type&&(e+=1+2*t.index),t.id&&(e+="["+t.id+"]"),e}).join("/"):""}segmentString(t){var e="/";return e+=this.joinSteps(t.steps),t.terminal&&null!=t.terminal.offset&&(e+=":"+t.terminal.offset),t.terminal&&null!=t.terminal.assertion&&(e+="["+t.terminal.assertion+"]"),e}toString(){var t="epubcfi(";return t+=this.segmentString(this.base),t+="!",t+=this.segmentString(this.path),this.range&&this.start&&(t+=",",t+=this.segmentString(this.start)),this.range&&this.end&&(t+=",",t+=this.segmentString(this.end)),t+=")"}compare(t,e){if("string"==typeof t&&(t=new EpubCFI(t)),"string"==typeof e&&(e=new EpubCFI(e)),t.spinePos>e.spinePos)return 1;if(t.spinePos<e.spinePos)return -1;t.range?(i=t.path.steps.concat(t.start.steps),n=t.start.terminal):(i=t.path.steps,n=t.path.terminal),e.range?(s=e.path.steps.concat(e.start.steps),r=e.start.terminal):(s=e.path.steps,r=e.path.terminal);for(var i,s,n,r,o=0;o<i.length;o++){if(!i[o])return -1;if(!s[o]||i[o].index>s[o].index)return 1;if(i[o].index<s[o].index)return -1}return i.length<s.length?-1:n.offset>r.offset?1:n.offset<r.offset?-1:0}step(t){var e=3===t.nodeType?"text":"element";return{id:t.id,tagName:t.tagName,type:e,index:this.position(t)}}filteredStep(t,e){var i,s=this.filter(t,e);if(s)return i=3===s.nodeType?"text":"element",{id:s.id,tagName:s.tagName,type:i,index:this.filteredPosition(s,e)}}pathTo(t,e,i){for(var s,n={steps:[],terminal:{offset:null,assertion:null}},r=t;r&&r.parentNode&&9!=r.parentNode.nodeType;)(s=i?this.filteredStep(r,i):this.step(r))&&n.steps.unshift(s),r=r.parentNode;return null!=e&&e>=0&&(n.terminal.offset=e,"text"!=n.steps[n.steps.length-1].type&&n.steps.push({type:"text",index:0})),n}equalStep(t,e){return!!t&&!!e&&t.index===e.index&&t.id===e.id&&t.type===e.type}fromRange(t,e,i){var s={range:!1,base:{},path:{},start:null,end:null},n=t.startContainer,r=t.endContainer,o=t.startOffset,a=t.endOffset,h=!1;if(i&&(h=null!=n.ownerDocument.querySelector("."+i)),"string"==typeof e?(s.base=this.parseComponent(e),s.spinePos=s.base.steps[1].index):"object"==typeof e&&(s.base=e),t.collapsed)h&&(o=this.patchOffset(n,o,i)),s.path=this.pathTo(n,o,i);else{s.range=!0,h&&(o=this.patchOffset(n,o,i)),s.start=this.pathTo(n,o,i),h&&(a=this.patchOffset(r,a,i)),s.end=this.pathTo(r,a,i),s.path={steps:[],terminal:null};var l,d=s.start.steps.length;for(l=0;l<d;l++)if(this.equalStep(s.start.steps[l],s.end.steps[l]))l===d-1?s.start.terminal===s.end.terminal&&(s.path.steps.push(s.start.steps[l]),s.range=!1):s.path.steps.push(s.start.steps[l]);else break;s.start.steps=s.start.steps.slice(s.path.steps.length),s.end.steps=s.end.steps.slice(s.path.steps.length)}return s}fromNode(t,e,i){var s={range:!1,base:{},path:{},start:null,end:null};return"string"==typeof e?(s.base=this.parseComponent(e),s.spinePos=s.base.steps[1].index):"object"==typeof e&&(s.base=e),s.path=this.pathTo(t,null,i),s}filter(t,e){var i,s,n,r,o,a=!1;return(3===t.nodeType?(a=!0,n=t.parentNode,i=t.parentNode.classList.contains(e)):(a=!1,i=t.classList.contains(e)),i&&a)?(r=n.previousSibling,o=n.nextSibling,r&&3===r.nodeType?s=r:o&&3===o.nodeType&&(s=o),s)?s:t:(!i||!!a)&&t}patchOffset(t,e,i){if(3!=t.nodeType)throw Error("Anchor must be a text node");var s=t,n=e;for(t.parentNode.classList.contains(i)&&(s=t.parentNode);s.previousSibling;){if(1===s.previousSibling.nodeType){if(s.previousSibling.classList.contains(i))n+=s.previousSibling.textContent.length;else break}else n+=s.previousSibling.textContent.length;s=s.previousSibling}return n}normalizedMap(t,e,i){var s,n,r,o={},a=-1,h=t.length;for(r=0;r<h;r++)1===(s=t[r].nodeType)&&t[r].classList.contains(i)&&(s=3),r>0&&3===s&&3===n?o[r]=a:e===s&&(a+=1,o[r]=a),n=s;return o}position(t){var e,i;return 1===t.nodeType?((e=t.parentNode.children)||(e=findChildren(t.parentNode)),i=Array.prototype.indexOf.call(e,t)):i=(e=this.textNodes(t.parentNode)).indexOf(t),i}filteredPosition(t,e){var i,s,n;return 1===t.nodeType?(i=t.parentNode.children,n=this.normalizedMap(i,1,e)):(i=t.parentNode.childNodes,t.parentNode.classList.contains(e)&&(i=(t=t.parentNode).parentNode.childNodes),n=this.normalizedMap(i,3,e)),n[s=Array.prototype.indexOf.call(i,t)]}stepsToXpath(t){var e=[".","*"];return t.forEach(function(t){var i=t.index+1;t.id?e.push("*[position()="+i+" and @id='"+t.id+"']"):"text"===t.type?e.push("text()["+i+"]"):e.push("*["+i+"]")}),e.join("/")}stepsToQuerySelector(t){var e=["html"];return t.forEach(function(t){var i=t.index+1;t.id?e.push("#"+t.id):"text"===t.type||e.push("*:nth-child("+i+")")}),e.join(">")}textNodes(t,e){return Array.prototype.slice.call(t.childNodes).filter(function(t){return 3===t.nodeType||!!(e&&t.classList.contains(e))})}walkToNode(t,e,i){var s,n,r,o=e||document,a=o.documentElement,h=t.length;for(r=0;r<h&&("element"===(n=t[r]).type?a=n.id?o.getElementById(n.id):(s=a.children||findChildren(a))[n.index]:"text"===n.type&&(a=this.textNodes(a,i)[n.index]),a);r++);return a}findNode(t,e,i){var s,n,r=e||document;return i||void 0===r.evaluate?s=i?this.walkToNode(t,r,i):this.walkToNode(t,r):(n=this.stepsToXpath(t),s=r.evaluate(n,r,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue),s}fixMiss(t,e,i,s){var n,r,o=this.findNode(t.slice(0,-1),i,s),a=o.childNodes,h=this.normalizedMap(a,3,s),l=t[t.length-1].index;for(let d in h){if(!h.hasOwnProperty(d))return;if(h[d]===l){if(e>(r=(n=a[d]).textContent.length))e-=r;else{o=1===n.nodeType?n.childNodes[0]:n;break}}}return{container:o,offset:e}}toRange(t,e){var i,s,n,r,o,a,h,l,d=t||document,c=!!e&&null!=d.querySelector("."+e);if(i=void 0!==d.createRange?d.createRange():new RangeObject,this.range?(s=this.start,a=this.path.steps.concat(s.steps),r=this.findNode(a,d,c?e:null),n=this.end,h=this.path.steps.concat(n.steps),o=this.findNode(h,d,c?e:null)):(s=this.path,a=this.path.steps,r=this.findNode(this.path.steps,d,c?e:null)),!r)return console.log("No startContainer found for",this.toString()),null;try{null!=s.terminal.offset?i.setStart(r,s.terminal.offset):i.setStart(r,0)}catch(u){l=this.fixMiss(a,s.terminal.offset,d,c?e:null),i.setStart(l.container,l.offset)}if(o)try{null!=n.terminal.offset?i.setEnd(o,n.terminal.offset):i.setEnd(o,0)}catch(p){l=this.fixMiss(h,this.end.terminal.offset,d,c?e:null),i.setEnd(l.container,l.offset)}return i}isCfiString(t){return"string"==typeof t&&0===t.indexOf("epubcfi(")&&")"===t[t.length-1]}generateChapterComponent(t,e,i){var s=parseInt(e),n="/"+(t+1)*2+"/";return n+=(s+1)*2,i&&(n+="["+i+"]"),n}collapse(t){this.range&&(this.range=!1,t?(this.path.steps=this.path.steps.concat(this.start.steps),this.path.terminal=this.start.terminal):(this.path.steps=this.path.steps.concat(this.end.steps),this.path.terminal=this.end.terminal))}}var table={application:{ecmascript:["es","ecma"],javascript:"js",ogg:"ogx",pdf:"pdf",postscript:["ps","ai","eps","epsi","epsf","eps2","eps3"],"rdf+xml":"rdf",smil:["smi","smil"],"xhtml+xml":["xhtml","xht"],xml:["xml","xsl","xsd","opf","ncx"],zip:"zip","x-httpd-eruby":"rhtml","x-latex":"latex","x-maker":["frm","maker","frame","fm","fb","book","fbdoc"],"x-object":"o","x-shockwave-flash":["swf","swfl"],"x-silverlight":"scr","epub+zip":"epub","font-tdpfr":"pfr","inkml+xml":["ink","inkml"],json:"json","jsonml+json":"jsonml","mathml+xml":"mathml","metalink+xml":"metalink",mp4:"mp4s","omdoc+xml":"omdoc",oxps:"oxps","vnd.amazon.ebook":"azw",widget:"wgt","x-dtbook+xml":"dtb","x-dtbresource+xml":"res","x-font-bdf":"bdf","x-font-ghostscript":"gsf","x-font-linux-psf":"psf","x-font-otf":"otf","x-font-pcf":"pcf","x-font-snf":"snf","x-font-ttf":["ttf","ttc"],"x-font-type1":["pfa","pfb","pfm","afm"],"x-font-woff":"woff","x-mobipocket-ebook":["prc","mobi"],"x-mspublisher":"pub","x-nzb":"nzb","x-tgif":"obj","xaml+xml":"xaml","xml-dtd":"dtd","xproc+xml":"xpl","xslt+xml":"xslt","internet-property-stream":"acx","x-compress":"z","x-compressed":"tgz","x-gzip":"gz"},audio:{flac:"flac",midi:["mid","midi","kar","rmi"],mpeg:["mpga","mpega","mp2","mp3","m4a","mp2a","m2a","m3a"],mpegurl:"m3u",ogg:["oga","ogg","spx"],"x-aiff":["aif","aiff","aifc"],"x-ms-wma":"wma","x-wav":"wav",adpcm:"adp",mp4:"mp4a",webm:"weba","x-aac":"aac","x-caf":"caf","x-matroska":"mka","x-pn-realaudio-plugin":"rmp",xm:"xm",mid:["mid","rmi"]},image:{gif:"gif",ief:"ief",jpeg:["jpeg","jpg","jpe"],pcx:"pcx",png:"png","svg+xml":["svg","svgz"],tiff:["tiff","tif"],"x-icon":"ico",bmp:"bmp",webp:"webp","x-pict":["pic","pct"],"x-tga":"tga","cis-cod":"cod"},text:{"cache-manifest":["manifest","appcache"],css:"css",csv:"csv",html:["html","htm","shtml","stm"],mathml:"mml",plain:["txt","text","brf","conf","def","list","log","in","bas"],richtext:"rtx","tab-separated-values":"tsv","x-bibtex":"bib"},video:{mpeg:["mpeg","mpg","mpe","m1v","m2v","mp2","mpa","mpv2"],mp4:["mp4","mp4v","mpg4"],quicktime:["qt","mov"],ogg:"ogv","vnd.mpegurl":["mxu","m4u"],"x-flv":"flv","x-la-asf":["lsf","lsx"],"x-mng":"mng","x-ms-asf":["asf","asx","asr"],"x-ms-wm":"wm","x-ms-wmv":"wmv","x-ms-wmx":"wmx","x-ms-wvx":"wvx","x-msvideo":"avi","x-sgi-movie":"movie","x-matroska":["mpv","mkv","mk3d","mks"],"3gpp2":"3g2",h261:"h261",h263:"h263",h264:"h264",jpeg:"jpgv",jpm:["jpm","jpgm"],mj2:["mj2","mjp2"],"vnd.ms-playready.media.pyv":"pyv","vnd.uvvu.mp4":["uvu","uvvu"],"vnd.vivo":"viv",webm:"webm","x-f4v":"f4v","x-m4v":"m4v","x-ms-vob":"vob","x-smv":"smv"}},mimeTypes=function(){var t,e,i,s,n={};for(t in table)if(table.hasOwnProperty(t)){for(e in table[t])if(table[t].hasOwnProperty(e)){if("string"==typeof(i=table[t][e]))n[i]=t+"/"+e;else for(s=0;s<i.length;s++)n[i[s]]=t+"/"+e}}return n}(),defaultValue="text/plain";function lookup(t){return t&&mimeTypes[t.split(".").pop().toLowerCase()]||defaultValue}class Resource{constructor(t={},e){if(t&&!t.url)throw Error("Resource url is required.");t.rel&&!Array.isArray(t.rel)&&(t.rel=[t.rel]),this.data={url:t.url,index:t.index,id:t.id,canonical:t.canonical,type:t.type,encoding:t.encoding||lookup(t.url),properites:t.properites||[],rel:t.rel||[],name:t.name,cfiPos:t.cfiPos,cfiBase:t.cfiBase}}get url(){return this.data.url}set url(t){this.data.url=t}get index(){return this.data.index}set index(t){this.data.index=t}get id(){return this.data.id}set id(t){this.data.id=t}get canonical(){return this.data.canonical}set canonical(t){this.data.canonical=t}get type(){return this.data.type}set type(t){this.data.type=t}get encoding(){return this.data.encoding}set encoding(t){this.data.id=t}get properites(){return this.data.properites}set properites(t){this.data.properites=t}get rel(){return this.data.rel}set rel(t){this.data.rel=t}get name(){return this.data.name}set name(t){this.data.name=t}get cfiPos(){return this.data.cfiPos}set cfiPos(t){this.data.cfiPos=t}get cfiBase(){return this.data.cfiBase}set cfiBase(t){this.data.cfiBase=t}async load(){return request(this.url,this.type)}toJSON(){return this.data}destroy(){}}class Locator{constructor(t={}){this.data={url:t.url,index:t.index,id:t.id,cfi:t.cfi,type:t.type,name:t.name,parent:void 0,children:new ResourceList}}get url(){return this.data.url}set url(t){this.data.url=t}get index(){return this.data.index}set index(t){this.data.index=t}get id(){return this.data.id}set id(t){this.data.id=t}get cfi(){return this.data.cfi}set cfi(t){this.data.cfi=t}get type(){return this.data.type}set type(t){this.data.type=t}get name(){return this.data.name}set name(t){return this.data.name}get parent(){return this.data.parent}set parent(t){return this.data.parent=t,this.data.parent}get children(){return this.data.children}set children(t){for(let e of t){let i=new Locator(e);i.parent=this,this.children.append(i)}return this.data.children}toJSON(){return this.data}destroy(){}}class DisplayOptions{constructor(t){this.interactive="",this.fixedLayout="",this.openToSpread="",this.orientationLock="",t&&this.parse(t)}parse(t){if(!t)return this;let e=qs(t,"display_options");if(!e)return this;let i=qsa(e,"option");return i.forEach(t=>{let e="";switch(t.childNodes.length&&(e=t.childNodes[0].nodeValue),t.attributes.name.value){case"interactive":this.interactive=e;break;case"fixed-layout":this.fixedLayout=e;break;case"open-to-spread":this.openToSpread=e;break;case"orientation-lock":this.orientationLock=e}}),this}destroy(){this.interactive=void 0,this.fixedLayout=void 0,this.openToSpread=void 0,this.orientationLock=void 0}}class Publication{constructor(t,e,i){this.data={url:"",metadata:new Map,navigation:new ResourceList,landmarks:new ResourceList,locations:new ResourceList,pagelist:new ResourceList,sections:new ResourceList,resources:new ResourceList,links:new ResourceList,uniqueResources:new ResourceList,displayOptions:new DisplayOptions},e&&(this.request=e),i&&(this.requestOptions=i),this.ids=[],t?this.opened=this.open(t):this.opened=Promise.resolve()}async open(){this.parse(data)}async unpack(t){if(!t)return;"string"==typeof t&&(t=JSON.parse(t));let{url:e,metadata:i,resources:s,toc:n,landmarks:r,locations:o,pagelist:a,sections:h,links:l}=t;this.url=e,this.metadata=i,this.resources=s,this.sections=h,this.toc=n,this.landmarks=r,this.locations=o,this.pagelist=a,this.links=l}load(t,e){let i=resolve(this.url,t);return this.request?this.request(i,e,this.requestOptions):request(i,e,this.requestOptions)}resolve(t,e){if(!t)return;let i=t;return isAbsolute(t)?t:(this.url&&(i=resolve(this.url,t)),i)}get url(){return this.data.url}set url(t){return this.data.url=t,this.data.url}get sections(){return this.data.sections}set sections(t){if(!t)return;let e=1;for(let i of t){"string"==typeof i&&(i={url:i}),i.url=resolve(this.url,i.url||i.href);let s=encodeURIComponent(filename(i.url).split(".")[0]),n=s,r=1;for(;this.ids.includes(n);)n=`${s}_${r++}`;s=n,this.ids.push(s),i.id=s,i.cfiBase=i.cfiBase||`2/${2*e}[${s}]`,i.canonical=i.canonical||i.cfiBase;let o=new Resource(i);this.data.sections.append(o),this.data.uniqueResources.add(o),e+=1}return this.data.sections}get metadata(){return this.data.metadata}set metadata(t){if(t){for(let[e,i]of Object.entries(t))this.data.metadata.set(e,i);return this.data.metadata}}get resources(){return this.data.resources}set resources(t){if(!t)return;let e=1;for(let i of t){"string"==typeof i&&(i={url:i}),i.url=this.resolve(i.url||i.href);let s=encodeURIComponent(filename(i.url).split(".")[0]),n=s,r=1;for(;this.ids.includes(n);)n=`${s}_${r++}`;s=n,this.ids.push(s),i.id=s,i.cfiBase=i.cfiBase||`4/${2*e}[${s}]`,i.canonical=i.canonical||i.cfiBase;let o=new Resource(i);this.data.resources.add(o),this.data.uniqueResources.add(o),e+=1}return this.data.resources}get uniqueResources(){return this.data.uniqueResources}set uniqueResources(t){if(t){for(let e of t){e.url=this.resolve(e.url||e.href),e.canonical=e.canonical||e.url;let i=new Resource(e);this.data.uniqueResources.add(i)}return this.data.uniqueResources}}get navigation(){return this.data.navigation}set navigation(t){if(t){for(let e of t){e.url=this.resolve(e.url||e.href),e.canonical=e.canonical||e.url;let i=new Locator(e);this.data.navigation.append(i)}return this.data.navigation}}get landmarks(){return this.data.landmarks}set landmarks(t){if(t){for(let e of t){e.url=this.resolve(e.url||e.href),e.canonical=e.canonical||e.url;let i=new Locator(e);this.data.landmarks.append(i)}return this.data.landmarks}}get locations(){return this.data.locations}set locations(t){if(t){for(let e of t){let i;if("string"==typeof e)i=new Locator({url:e,cfi:e});else{let{url:s,cfi:n}=e;i=new Locator({url:s||n,cfi:n||s})}this.data.locations.append(i)}return this.data.locations}}get pagelist(){return this.data.pagelist}set pagelist(t){if(t){for(let e of t){e.url=this.resolve(e.url||e.href),e.canonical=e.canonical||e.url;let i=new Locator(e);this.data.pagelist.append(i)}return this.data.pagelist}}get links(){return this.data.links}set links(t){return this.data.links=t}get displayOptions(){return this.data.displayOptions}set displayOptions(t){return this.data.displayOptions=new DisplayOptions(t),this.data.displayOptions}get coverUrl(){let t=this.data.resources.find(t=>t.rel.includes("cover"));return t&&t.url}set coverUrl(t){let e=this.data.resources.find(t=>t.includes("cover"));return e?e.url=t:(e=new Resource({rel:["cover"],url:t}),this.data.resources.add(e)),e&&e.url}get contentsUrl(){let t=this.data.resources.find(t=>t.rel.includes("contents"));return t&&t.url}set contentsUrl(t){let e=this.data.resources.find(t=>t.rel.includes("contents"));return e?e.url=t:(e={rel:["contents"],url:t},this.data.resources.add(e)),e&&e.url}get landmarksUrl(){let t=this.data.resources.find(t=>t.rel.includes("landmarks"));return t&&t.url}set landmarksUrl(t){let e=this.data.resources.find(t=>t.rel.includes("landmarks"));return e?e.url=t:(e={rel:["landmarks"],url:t},this.data.resources.add(e)),e&&e.url}get pagelistUrl(){let t=this.data.resources.find(t=>t.rel.includes("pagelist"));return t&&t.url}set pagelistUrl(t){let e=this.data.resources.find(t=>t.rel.includes("pagelist"));return e?e.url=t:(e={rel:["pagelist"],url:t},this.data.resources.add(e)),e&&e.url}get locationsUrl(){let t=this.data.resources.find(t=>t.rel.includes("locations"));return t&&t.url}set locationsUrl(t){let e=this.data.resources.find(t=>t.rel.includes("locations"));return e?e.url=t:(e={rel:["locations"],url:t},this.data.resources.add(e)),e&&e.url}getRange(t){var e=new EpubCFI(t),i=this.sections.get(e.spinePos);return i?i.load().then(function(t){return e.toRange(i.document)}):new Promise((t,e)=>{e("CFI could not be found")})}key(t){return`epubjs-0.4-${t||this.metadata.get("id")||this.metadata.get("identifier")}`}toObject(){return this.data}toJSON(){return this.data}destroy(){this.data=void 0}}EventEmitter(Publication.prototype);class Hook{constructor(t){this.context=t||this,this.hooks=[]}register(){for(var t=0;t<arguments.length;++t)if("function"==typeof arguments[t])this.hooks.push(arguments[t]);else for(var e=0;e<arguments[t].length;++e)this.hooks.push(arguments[t][e])}trigger(){var t=arguments,e=this.context,i=[];return this.hooks.forEach(function(s){var n=s.apply(e,t);n&&"function"==typeof n.then&&i.push(n),i.push(new Promise((t,e)=>{t(n)}))}),Promise.all(i)}triggerSync(){var t=arguments,e=this.context,i=[];return this.hooks.forEach(function(s){var n=s.apply(e,t);i.push(n)}),i}list(){return this.hooks}clear(){return this.hooks=[]}}class Queue{constructor(t){this._q=[],this.context=t,this.tick=requestAnimationFrame,this.running=!1,this.paused=!1}enqueue(){var t,e,i,s=[].shift.call(arguments),n=arguments;if(!s)throw Error("No Task Provided");return"function"==typeof s?(e=(t=new defer).promise,i={task:s,args:n,deferred:t,promise:e}):i={promise:s},this._q.push(i),!1!=this.paused||this.running||this.run(),i.promise}dequeue(){var t,e,i;return!this._q.length||this.paused?((t=new defer).deferred.resolve(),t.promise):(e=(t=this._q.shift()).task)?(i=e.apply(this.context,t.args))&&"function"==typeof i.then?i.then((function(){t.deferred.resolve.apply(this.context,arguments)}).bind(this),(function(){t.deferred.reject.apply(this.context,arguments)}).bind(this)):(t.deferred.resolve.apply(this.context,i),t.promise):t.promise?t.promise:void 0}dump(){for(;this._q.length;)this.dequeue()}run(){return this.running||(this.running=!0,this.defered=new defer),this.tick.call(window,()=>{this._q.length?this.dequeue().then((function(){this.run()}).bind(this)):(this.defered.resolve(),this.running=void 0)}),!0==this.paused&&(this.paused=!1),this.defered.promise}flush(){return this.running?this.running:this._q.length?(this.running=this.dequeue().then((function(){return this.running=void 0,this.flush()}).bind(this)),this.running):void 0}clear(){this._q=[]}length(){return this._q.length}pause(){this.paused=!0}stop(){this._q=[],this.running=!1,this.paused=!0}}class Layout{constructor(t){this.settings=t,this.name=t.layout||"reflowable",this._spread="none"!==t.spread,this._minSpreadWidth=t.minSpreadWidth||800,this._evenSpreads=t.evenSpreads||!1,"scrolled"===t.flow||"scrolled-continuous"===t.flow||"scrolled-doc"===t.flow?this._flow="scrolled":this._flow="paginated",this.width=0,this.height=0,this.spreadWidth=0,this.delta=0,this.columnWidth=0,this.gap=0,this.divisor=1,this.props={name:this.name,spread:this._spread,flow:this._flow,width:0,height:0,spreadWidth:0,delta:0,columnWidth:0,gap:0,divisor:1}}flow(t){return void 0!==t&&("scrolled"===t||"scrolled-continuous"===t||"scrolled-doc"===t?this._flow="scrolled":this._flow="paginated",this.update({flow:this._flow})),this._flow}spread(t,e){return t&&(this._spread="none"!==t,this.update({spread:this._spread})),e>=0&&(this._minSpreadWidth=e),this._spread}calculate(t,e,i){var s,n,r,o,a=1,h=i||0,l=t,d=e,c=Math.floor(l/12);a=this._spread&&l>=this._minSpreadWidth?2:1,"reflowable"!==this.name||"paginated"!==this._flow||i>=0||(h=c%2==0?c:c-1),"pre-paginated"===this.name&&(h=0),a>1?r=(s=l/a-h)+h:(s=l,r=l),"pre-paginated"===this.name&&a>1&&(l=s),n=s*a+h,o=l,this.width=l,this.height=d,this.spreadWidth=n,this.pageWidth=r,this.delta=o,this.columnWidth=s,this.gap=h,this.divisor=a,this.update({width:l,height:d,spreadWidth:n,pageWidth:r,delta:o,columnWidth:s,gap:h,divisor:a})}format(t,e,i){var s;return"pre-paginated"===this.name?t.fit(this.columnWidth,this.height,e):"paginated"===this._flow?t.columns(this.width,this.height,this.columnWidth,this.gap,this.settings.direction):i&&"horizontal"===i?t.size(null,this.height):t.size(this.width,null)}count(t,e){let i,s;return"pre-paginated"===this.name?(i=1,s=1):s="paginated"===this._flow?(i=Math.ceil(t/(e=e||this.delta)))*this.divisor:i=Math.ceil(t/(e=e||this.height)),{spreads:i,pages:s}}update(t){if(Object.keys(t).forEach(e=>{this.props[e]===t[e]&&delete t[e]}),Object.keys(t).length>0){let e=extend(this.props,t);this.emit(EVENTS.LAYOUT.UPDATED,e,t)}}}EventEmitter(Layout.prototype);class Themes{constructor(t){this.rendition=t,this._themes={default:{rules:{},url:"",serialized:""}},this._overrides={},this._current="default",this._injected=[],this.rendition.hooks.content.register(this.inject.bind(this)),this.rendition.hooks.content.register(this.overrides.bind(this))}register(){return 0===arguments.length?void 0:1===arguments.length&&"object"==typeof arguments[0]?this.registerThemes(arguments[0]):1===arguments.length&&"string"==typeof arguments[0]?this.default(arguments[0]):2===arguments.length&&"string"==typeof arguments[1]?this.registerUrl(arguments[0],arguments[1]):2===arguments.length&&"object"==typeof arguments[1]?this.registerRules(arguments[0],arguments[1]):void 0}default(t){return t?"string"==typeof t?this.registerUrl("default",t):"object"==typeof t?this.registerRules("default",t):void 0:void 0}registerThemes(t){for(var e in t)t.hasOwnProperty(e)&&("string"==typeof t[e]?this.registerUrl(e,t[e]):this.registerRules(e,t[e]))}registerCss(t,e){this._themes[t]={serialized:e},(this._injected[t]||"default"==t)&&this.update(t)}registerUrl(t,e){var i=createUrl(e);this._themes[t]={url:i.toString()},(this._injected[t]||"default"==t)&&this.update(t)}registerRules(t,e){this._themes[t]={rules:e},(this._injected[t]||"default"==t)&&this.update(t)}select(t){var e,i=this._current;this._current=t,this.update(t),(e=this.rendition.getContents()).forEach(e=>{e.removeClass(i),e.addClass(t)})}update(t){this.rendition.getContents().forEach(e=>{this.add(t,e)})}inject(t){var e,i=[],s=this._themes;for(var n in s)s.hasOwnProperty(n)&&(n===this._current||"default"===n)&&(((e=s[n]).rules&&Object.keys(e.rules).length>0||e.url&&-1===i.indexOf(e.url))&&this.add(n,t),this._injected.push(n));"default"!=this._current&&t.addClass(this._current)}add(t,e){var i=this._themes[t];i&&e&&(i.url?e.addStylesheet(i.url):i.serialized?(e.addStylesheetCss(i.serialized,t),i.injected=!0):i.rules&&(e.addStylesheetRules(i.rules,t),i.injected=!0))}override(t,e,i){var s=this.rendition.getContents();this._overrides[t]={value:e,priority:!0===i},s.forEach(e=>{e.css(t,this._overrides[t].value,this._overrides[t].priority)})}removeOverride(t){var e=this.rendition.getContents();delete this._overrides[t],e.forEach(e=>{e.css(t)})}overrides(t){var e=this._overrides;for(var i in e)e.hasOwnProperty(i)&&t.css(i,e[i].value,e[i].priority)}fontSize(t){this.override("font-size",t)}font(t){this.override("font-family",t,!0)}destroy(){this.rendition=void 0,this._themes=void 0,this._overrides=void 0,this._current=void 0,this._injected=void 0}}class Mapping{constructor(t,e,i,s=!1){this.layout=t,this.horizontal="horizontal"===i,this.direction=e||"ltr",this._dev=s}section(t){var e=this.findRanges(t);return this.rangeListToCfiList(t.section.cfiBase,e)}page(t,e,i,s){var n,r=!!t&&!!t.document&&t.document.body;if(r){if(n=this.rangePairToCfiPair(e,{start:this.findStart(r,i,s),end:this.findEnd(r,i,s)}),!0===this._dev){let o=t.document,a=new EpubCFI(n.start).toRange(o),h=new EpubCFI(n.end).toRange(o),l=o.defaultView.getSelection(),d=o.createRange();l.removeAllRanges(),d.setStart(a.startContainer,a.startOffset),d.setEnd(h.endContainer,h.endOffset),l.addRange(d)}return n}}walk(t,e){if(!t||t.nodeType!==Node.TEXT_NODE){var i,s,n={acceptNode:function(t){return t.data.trim().length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},r=n.acceptNode;r.acceptNode=n.acceptNode;for(var o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,r,!1);(i=o.nextNode())&&!(s=e(i)););return s}}findRanges(t){for(var e,i,s=[],n=Math.ceil(t.contents.scrollWidth()/this.layout.spreadWidth)*this.layout.divisor,r=this.layout.columnWidth,o=this.layout.gap,a=0;a<n.pages;a++)e=(r+o)*a,i=r*(a+1)+o*a,s.push({start:this.findStart(t.document.body,e,i),end:this.findEnd(t.document.body,e,i)});return s}findStart(t,e,i){for(var s,n,r=[t],o=t;r.length;)if(s=r.shift(),n=this.walk(s,t=>{var s,n,a,h,l;if(l=nodeBounds(t),this.horizontal&&"ltr"===this.direction){if(s=this.horizontal?l.left:l.top,n=this.horizontal?l.right:l.bottom,s>=e&&s<=i)return t;if(n>e)return t;o=t,r.push(t)}else if(this.horizontal&&"rtl"===this.direction){if(s=l.left,(n=l.right)<=i&&n>=e)return t;if(s<i)return t;o=t,r.push(t)}else{if(a=l.top,h=l.bottom,a>=e&&a<=i)return t;if(h>e)return t;o=t,r.push(t)}}))return this.findTextStartRange(n,e,i);return this.findTextStartRange(o,e,i)}findEnd(t,e,i){for(var s,n,r=[t],o=t;r.length;)if(s=r.shift(),n=this.walk(s,t=>{var s,n,a,h,l;if(l=nodeBounds(t),this.horizontal&&"ltr"===this.direction){if(s=Math.round(l.left),n=Math.round(l.right),s>i&&o)return o;if(n>i)return t;o=t,r.push(t)}else if(this.horizontal&&"rtl"===this.direction){if(s=Math.round(this.horizontal?l.left:l.top),(n=Math.round(this.horizontal?l.right:l.bottom))<e&&o)return o;if(s<e)return t;o=t,r.push(t)}else{if(a=Math.round(l.top),h=Math.round(l.bottom),a>i&&o)return o;if(h>i)return t;o=t,r.push(t)}}))return this.findTextEndRange(n,e,i);return this.findTextEndRange(o,e,i)}findTextStartRange(t,e,i){for(var s,n,r,o,a,h=this.splitTextNodeIntoRanges(t),l=0;l<h.length;l++)if(n=(s=h[l]).getBoundingClientRect(),this.horizontal&&"ltr"===this.direction){if((r=n.left)>=e)return s}else if(this.horizontal&&"rtl"===this.direction){if((a=n.right)<=i)return s}else if((o=n.top)>=e)return s;return h[0]}findTextEndRange(t,e,i){for(var s,n,r,o,a,h,l,d=this.splitTextNodeIntoRanges(t),c=0;c<d.length;c++){if(r=(n=d[c]).getBoundingClientRect(),this.horizontal&&"ltr"===this.direction){if(o=r.left,a=r.right,o>i&&s)return s;if(a>i)return n}else if(this.horizontal&&"rtl"===this.direction){if(o=r.left,(a=r.right)<e&&s)return s;if(o<e)return n}else{if(h=r.top,l=r.bottom,h>i&&s)return s;if(l>i)return n}s=n}return d[d.length-1]}splitTextNodeIntoRanges(t,e){var i,s=[],n=(t.textContent||"").trim(),r=t.ownerDocument,o=e||" ",a=n.indexOf(o);if(-1===a||t.nodeType!=Node.TEXT_NODE)return(i=r.createRange()).selectNodeContents(t),[i];for((i=r.createRange()).setStart(t,0),i.setEnd(t,a),s.push(i),i=!1;-1!=a;)(a=n.indexOf(o,a+1))>0&&(i&&(i.setEnd(t,a),s.push(i)),(i=r.createRange()).setStart(t,a+1));return i&&(i.setEnd(t,n.length),s.push(i)),s}rangePairToCfiPair(t,e){var i=e.start,s=e.end;i.collapse(!0),s.collapse(!1);let n=new EpubCFI(i,t).toString(),r=new EpubCFI(s,t).toString();return{start:n,end:r}}rangeListToCfiList(t,e){for(var i,s=[],n=0;n<e.length;n++)s.push(i=this.rangePairToCfiPair(t,e[n]));return s}axis(t){return t&&(this.horizontal="horizontal"===t),this.horizontal}}function replaceBase(t,e){var i,s,n=e.href,r=n.indexOf("://")>-1;if(t){if(s=qs(t,"head"),(i=qs(s,"base"))||(i=t.createElement("base"),s.insertBefore(i,s.firstChild)),!r&&"undefined"!=typeof window&&window.location){let o=window.location.href.split("/"),a="";o.pop(),n=(a=o.join("/"))+n}i.setAttribute("href",n)}}function replaceLinks(t,e){let i=t.querySelectorAll("a[href]");if(!i.length)return;let s=qs(t.ownerDocument,"base"),n=s?s.getAttribute("href"):t.ownerDocument.defaultView.location.href,r=(function(t){var i=t.getAttribute("href");0!==i.indexOf("mailto:")&&(i.indexOf("://"),isAbsolute(i)?t.setAttribute("target","_blank"):t.onclick=function(){let t=createUrl(i,n);return e(t.toString()),!1})}).bind(this);for(var o=0;o<i.length;o++)r(i[o])}let hasNavigator="undefined"!=typeof navigator,isChrome=hasNavigator&&/Chrome/.test(navigator.userAgent),isWebkit=hasNavigator&&!isChrome&&/AppleWebKit/.test(navigator.userAgent),ELEMENT_NODE=1;class Contents{constructor(t,e,i,s){this.epubcfi=new EpubCFI,this.document=t,this.documentElement=this.document.documentElement,this.content=e||this.document.body,this.window=this.document.defaultView,this._size={width:0,height:0},this.sectionIndex=s||0,this.cfiBase=i||"",this.epubReadingSystem("epub.js","0.4"),this.called=0,this.active=!0,this.listeners()}static get listenedEvents(){return DOM_EVENTS}width(t){var e=this.content;return t&&isNumber(t)&&(t+="px"),t&&(e.style.width=t),parseInt(this.window.getComputedStyle(e).width)}height(t){var e=this.content;return t&&isNumber(t)&&(t+="px"),t&&(e.style.height=t),parseInt(this.window.getComputedStyle(e).height)}contentWidth(t){var e=this.content||this.document.body;return t&&isNumber(t)&&(t+="px"),t&&(e.style.width=t),parseInt(this.window.getComputedStyle(e).width)}contentHeight(t){var e=this.content||this.document.body;return t&&isNumber(t)&&(t+="px"),t&&(e.style.height=t),parseInt(this.window.getComputedStyle(e).height)}textWidth(){let t,e,i=this.document.createRange(),s=this.content||this.document.body,n=borders(s);return i.selectNodeContents(s),e=(t=i.getBoundingClientRect()).width,n&&n.width&&(e+=n.width),Math.round(e)}textHeight(){let t,e,i=this.document.createRange(),s=this.content||this.document.body;return i.selectNodeContents(s),Math.round(e=(t=i.getBoundingClientRect()).bottom)}scrollWidth(){return this.documentElement.scrollWidth}scrollHeight(){return this.documentElement.scrollHeight}overflow(t){return t&&(this.documentElement.style.overflow=t),this.window.getComputedStyle(this.documentElement).overflow}overflowX(t){return t&&(this.documentElement.style.overflowX=t),this.window.getComputedStyle(this.documentElement).overflowX}overflowY(t){return t&&(this.documentElement.style.overflowY=t),this.window.getComputedStyle(this.documentElement).overflowY}css(t,e,i){var s=this.content||this.document.body;return e?s.style.setProperty(t,e,i?"important":""):s.style.removeProperty(t),this.window.getComputedStyle(s)[t]}viewport(t){var e=this.document.querySelector("meta[name='viewport']"),i={width:void 0,height:void 0,scale:void 0,minimum:void 0,maximum:void 0,scalable:void 0},s=[],n={};if(e&&e.hasAttribute("content")){let r=e.getAttribute("content"),o=r.match(/width\s*=\s*([^,]*)/),a=r.match(/height\s*=\s*([^,]*)/),h=r.match(/initial-scale\s*=\s*([^,]*)/),l=r.match(/minimum-scale\s*=\s*([^,]*)/),d=r.match(/maximum-scale\s*=\s*([^,]*)/),c=r.match(/user-scalable\s*=\s*([^,]*)/);o&&o.length&&void 0!==o[1]&&(i.width=o[1]),a&&a.length&&void 0!==a[1]&&(i.height=a[1]),h&&h.length&&void 0!==h[1]&&(i.scale=h[1]),l&&l.length&&void 0!==l[1]&&(i.minimum=l[1]),d&&d.length&&void 0!==d[1]&&(i.maximum=d[1]),c&&c.length&&void 0!==c[1]&&(i.scalable=c[1])}return n=defaults(t||{},i),t&&(n.width&&s.push("width="+n.width),n.height&&s.push("height="+n.height),n.scale&&s.push("initial-scale="+n.scale),"no"===n.scalable?(s.push("minimum-scale="+n.scale),s.push("maximum-scale="+n.scale),s.push("user-scalable="+n.scalable)):(n.scalable&&s.push("user-scalable="+n.scalable),n.minimum&&s.push("minimum-scale="+n.minimum),n.maximum&&s.push("minimum-scale="+n.maximum)),e||((e=this.document.createElement("meta")).setAttribute("name","viewport"),this.document.querySelector("head").appendChild(e)),e.setAttribute("content",s.join(", ")),this.window.scrollTo(0,0)),n}expand(){this.emit(EVENTS.CONTENTS.EXPAND)}listeners(){this.imageLoadListeners(),this.mediaQueryListeners(),this.addEventListeners(),this.addSelectionListeners(),"undefined"==typeof ResizeObserver?(this.resizeListeners(),this.visibilityListeners()):this.resizeObservers(),this.linksHandler()}removeListeners(){this.removeEventListeners(),this.removeSelectionListeners(),this.observer&&this.observer.disconnect(),clearTimeout(this.expanding)}resizeCheck(){let t=this.textWidth(),e=this.textHeight();(t!=this._size.width||e!=this._size.height)&&(this._size={width:t,height:e},this.onResize&&this.onResize(this._size),this.emit(EVENTS.CONTENTS.RESIZE,this._size))}resizeListeners(){clearTimeout(this.expanding),requestAnimationFrame(this.resizeCheck.bind(this)),this.expanding=setTimeout(this.resizeListeners.bind(this),350)}visibilityListeners(){document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&!1===this.active?(this.active=!0,this.resizeListeners()):(this.active=!1,clearTimeout(this.expanding))})}transitionListeners(){let t=this.content;t.style.transitionProperty="font, font-size, font-size-adjust, font-stretch, font-variation-settings, font-weight, width, height",t.style.transitionDuration="0.001ms",t.style.transitionTimingFunction="linear",t.style.transitionDelay="0",this._resizeCheck=this.resizeCheck.bind(this),this.document.addEventListener("transitionend",this._resizeCheck)}mediaQueryListeners(){for(var t,e=this.document.styleSheets,i=(function(t){t.matches&&!this._expanding&&setTimeout(this.expand.bind(this),1)}).bind(this),s=0;s<e.length;s+=1){try{t=e[s].cssRules}catch(n){return}if(!t)return;for(var r=0;r<t.length;r+=1)t[r].media&&this.window.matchMedia(t[r].media.mediaText).addListener(i)}}resizeObservers(){this.observer=new ResizeObserver(t=>{requestAnimationFrame(this.resizeCheck.bind(this))}),this.observer.observe(this.document.documentElement)}mutationObservers(){this.observer=new MutationObserver(t=>{this.resizeCheck()}),this.observer.observe(this.document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}imageLoadListeners(){for(var t,e=this.document.querySelectorAll("img"),i=0;i<e.length;i++)void 0!==(t=e[i]).naturalWidth&&0===t.naturalWidth&&(t.onload=this.expand.bind(this))}fontLoadListeners(){this.document&&this.document.fonts&&this.document.fonts.ready.then((function(){this.resizeCheck()}).bind(this))}root(){return this.document?this.document.documentElement:null}locationOf(t,e){var i,s={left:0,top:0};if(!this.document)return s;if(this.epubcfi.isCfiString(t)){let n=new EpubCFI(t).toRange(this.document,e);if(n){try{if(!n.endContainer||n.startContainer==n.endContainer&&n.startOffset==n.endOffset){let r=n.startContainer.textContent.indexOf(" ",n.startOffset);-1==r&&(r=n.startContainer.textContent.length),n.setEnd(n.startContainer,r)}}catch(o){console.error("setting end offset to start container length failed",o)}if(n.startContainer.nodeType===Node.ELEMENT_NODE)i=n.startContainer.getBoundingClientRect(),s.left=i.left,s.top=i.top;else if(isWebkit){let a=n.startContainer,h=new Range;try{1===a.nodeType?i=a.getBoundingClientRect():n.startOffset+2<a.length?(h.setStart(a,n.startOffset),h.setEnd(a,n.startOffset+2),i=h.getBoundingClientRect()):n.startOffset-2>0?(h.setStart(a,n.startOffset-2),h.setEnd(a,n.startOffset),i=h.getBoundingClientRect()):i=a.parentNode.getBoundingClientRect()}catch(l){console.error(l,l.stack)}}else i=n.getBoundingClientRect()}}else if("string"==typeof t&&t.indexOf("#")>-1){let d=t.substring(t.indexOf("#")+1),c=this.document.getElementById(d);if(c){if(isWebkit){let u=new Range;u.selectNode(c),i=u.getBoundingClientRect()}else i=c.getBoundingClientRect()}}return i&&(s.left=i.left,s.top=i.top),s}addStylesheet(t){return new Promise((function(e,i){var s,n=!1;if(!this.document){e(!1);return}if(s=this.document.querySelector("link[href='"+t+"']")){e(!0);return}(s=this.document.createElement("link")).type="text/css",s.rel="stylesheet",s.href=t,s.onload=s.onreadystatechange=function(){n||this.readyState&&"complete"!=this.readyState||(n=!0,setTimeout(()=>{e(!0)},1))},this.document.head.appendChild(s)}).bind(this))}_getStylesheetNode(t){var e;return t="epubjs-inserted-css-"+(t||""),!!this.document&&((e=this.document.getElementById(t))||((e=this.document.createElement("style")).id=t,this.document.head.appendChild(e)),e)}addStylesheetCss(t,e){var i;return!!this.document&&!!t&&((i=this._getStylesheetNode(e)).innerHTML=t,!0)}addStylesheetRules(t,e){var i;if(this.document&&t&&0!==t.length){if(i=this._getStylesheetNode(e).sheet,"[object Array]"===Object.prototype.toString.call(t))for(var s=0,n=t.length;s<n;s++){var r=1,o=t[s],a=t[s][0],h="";"[object Array]"===Object.prototype.toString.call(o[1][0])&&(o=o[1],r=0);for(var l=o.length;r<l;r++){var d=o[r];h+=d[0]+":"+d[1]+(d[2]?" !important":"")+";\n"}i.insertRule(a+"{"+h+"}",i.cssRules.length)}else{let c=Object.keys(t);c.forEach(e=>{let s=t[e];if(Array.isArray(s))s.forEach(t=>{let s=Object.keys(t),n=s.map(e=>`${e}:${t[e]}`).join(";");i.insertRule(`${e}{${n}}`,i.cssRules.length)});else{let n=Object.keys(s),r=n.map(t=>`${t}:${s[t]}`).join(";");i.insertRule(`${e}{${r}}`,i.cssRules.length)}})}}}addScript(t){return new Promise((function(e,i){var s,n=!1;if(!this.document){e(!1);return}(s=this.document.createElement("script")).type="text/javascript",s.async=!0,s.src=t,s.onload=s.onreadystatechange=function(){n||this.readyState&&"complete"!=this.readyState||(n=!0,setTimeout(function(){e(!0)},1))},this.document.head.appendChild(s)}).bind(this))}addClass(t){var e;this.document&&(e=this.content||this.document.body)&&e.classList.add(t)}removeClass(t){var e;this.document&&(e=this.content||this.document.body)&&e.classList.remove(t)}addEventListeners(){this.document&&(this._triggerEvent=this.triggerEvent.bind(this),DOM_EVENTS.forEach(function(t){this.document.addEventListener(t,this._triggerEvent,{passive:!0})},this))}removeEventListeners(){this.document&&(DOM_EVENTS.forEach(function(t){this.document.removeEventListener(t,this._triggerEvent,{passive:!0})},this),this._triggerEvent=void 0)}triggerEvent(t){this.emit(t.type,t)}addSelectionListeners(){this.document&&(this._onSelectionChange=this.onSelectionChange.bind(this),this.document.addEventListener("selectionchange",this._onSelectionChange,{passive:!0}))}removeSelectionListeners(){this.document&&(this.document.removeEventListener("selectionchange",this._onSelectionChange,{passive:!0}),this._onSelectionChange=void 0)}onSelectionChange(t){this.selectionEndTimeout&&clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=setTimeout((function(){var t=this.window.getSelection();this.triggerSelectedEvent(t)}).bind(this),250)}triggerSelectedEvent(t){var e,i;t&&t.rangeCount>0&&!(e=t.getRangeAt(0)).collapsed&&(i=new EpubCFI(e,this.cfiBase).toString(),this.emit(EVENTS.CONTENTS.SELECTED,i),this.emit(EVENTS.CONTENTS.SELECTED_RANGE,e))}range(t,e){return new EpubCFI(t).toRange(this.document,e)}cfiFromRange(t,e){return new EpubCFI(t,this.cfiBase,e).toString()}cfiFromNode(t,e){return new EpubCFI(t,this.cfiBase,e).toString()}map(t){return new Mapping(t).section()}size(t,e){var i={scale:1,scalable:"no"};this.layoutStyle("scrolling"),t>=0&&(this.width(t),i.width=t,this.css("padding","0 "+t/12+"px")),e>=0&&(this.height(e),i.height=e),this.css("margin","0"),this.css("box-sizing","border-box"),this.viewport(i)}columns(t,e,i,s,n){let r=prefixed("column-axis"),o=prefixed("column-gap"),a=prefixed("column-width"),h=prefixed("column-fill"),l=0===this.writingMode().indexOf("vertical")?"vertical":"horizontal";this.layoutStyle("paginated"),"rtl"===n&&"horizontal"===l&&this.direction(n),this.width(t),this.height(e),this.viewport({width:t,height:e,scale:1,scalable:"no"}),this.css("overflow-y","hidden"),this.css("margin","0",!0),"vertical"===l?(this.css("padding-top",s/2+"px",!0),this.css("padding-bottom",s/2+"px",!0),this.css("padding-left","20px"),this.css("padding-right","20px"),this.css(r,"vertical")):(this.css("padding-top","20px"),this.css("padding-bottom","20px"),this.css("padding-left",s/2+"px",!0),this.css("padding-right",s/2+"px",!0),this.css(r,"horizontal")),this.css("box-sizing","border-box"),this.css("max-width","inherit"),this.css(h,"auto"),this.css(o,s+"px"),this.css(a,i+"px"),this.css("-webkit-line-box-contain","block glyphs replaced")}scaler(t,e,i){var s="";this.css("transform-origin","top left"),(e>=0||i>=0)&&(s=" translate("+(e||0)+"px, "+(i||0)+"px )"),this.css("transform","scale("+t+")"+s)}fit(t,e,i){var s=this.viewport(),n=parseInt(s.width),r=parseInt(s.height),o=t/n,a=e/r,h=o<a?o:a;this.layoutStyle("paginated"),this.width(n),this.height(r),this.overflow("hidden"),this.scaler(h,0,0),this.css("background-size",n*h+"px "+r*h+"px"),this.css("background-color","transparent"),i&&i.properties.includes("page-spread-left")&&this.css("margin-left",t-n*h+"px")}direction(t){this.documentElement&&(this.documentElement.style.direction=t)}mapPage(t,e,i,s,n){return new Mapping(e,n).page(this,t,i,s)}linksHandler(){replaceLinks(this.content,t=>{this.emit(EVENTS.CONTENTS.LINK_CLICKED,t)})}writingMode(t){let e=prefixed("writing-mode");return t&&this.documentElement&&(this.documentElement.style[e]=t),this.window.getComputedStyle(this.documentElement)[e]||""}layoutStyle(t){return t&&(this._layoutStyle=t,navigator.epubReadingSystem.layoutStyle=this._layoutStyle),this._layoutStyle||"paginated"}epubReadingSystem(t,e){return navigator.epubReadingSystem={name:t,version:e,layoutStyle:this.layoutStyle(),hasFeature:function(t){switch(t){case"dom-manipulation":case"layout-changes":case"touch-events":case"mouse-events":case"keyboard-events":return!0;default:return!1}}},navigator.epubReadingSystem}destroy(){this.removeListeners()}}EventEmitter(Contents.prototype);class Annotations{constructor(t){this.rendition=t,this.highlights=[],this.underlines=[],this.marks=[],this._annotations={},this._annotationsBySectionIndex={},this.rendition.hooks.render.register(this.inject.bind(this)),this.rendition.hooks.unloaded.register(this.clear.bind(this))}add(t,e,i,s,n,r){let o=encodeURI(e+t),a=new EpubCFI(e).spinePos,h=new Annotation({type:t,cfiRange:e,data:i,sectionIndex:a,cb:s,className:n,styles:r});return this._annotations[o]=h,a in this._annotationsBySectionIndex?this._annotationsBySectionIndex[a].push(o):this._annotationsBySectionIndex[a]=[o],this.rendition.views().forEach(t=>{h.sectionIndex===t.index&&h.attach(t)}),h}remove(t,e){let i=encodeURI(t+e);if(i in this._annotations){let s=this._annotations[i];if(e&&s.type!==e)return;this.rendition.views().forEach(t=>{this._removeFromAnnotationBySectionIndex(s.sectionIndex,i),s.sectionIndex===t.index&&s.detach(t)}),delete this._annotations[i]}}_removeFromAnnotationBySectionIndex(t,e){this._annotationsBySectionIndex[t]=this._annotationsAt(t).filter(t=>t!==e)}_annotationsAt(t){return this._annotationsBySectionIndex[t]}highlight(t,e,i,s,n){return this.add("highlight",t,e,i,s,n)}underline(t,e,i,s,n){return this.add("underline",t,e,i,s,n)}mark(t,e,i){return this.add("mark",t,e,i)}each(){return this._annotations.forEach.apply(this._annotations,arguments)}inject(t){let e=t.index;e in this._annotationsBySectionIndex&&this._annotationsBySectionIndex[e].forEach(e=>{this._annotations[e].attach(t)})}clear(t){let e=t.index;e in this._annotationsBySectionIndex&&this._annotationsBySectionIndex[e].forEach(e=>{this._annotations[e].detach(t)})}show(){}hide(){}}class Annotation{constructor({type:t,cfiRange:e,data:i,sectionIndex:s,cb:n,className:r,styles:o}){this.type=t,this.cfiRange=e,this.data=i,this.sectionIndex=s,this.mark=void 0,this.cb=n,this.className=r,this.styles=o}update(t){this.data=t}attach(t){let{cfiRange:e,data:i,type:s,mark:n,cb:r,className:o,styles:a}=this,h;return"highlight"===s?h=t.highlight(e,i,r,o,a):"underline"===s?h=t.underline(e,i,r,o,a):"mark"===s&&(h=t.mark(e,i,r)),this.mark=h,this.emit(EVENTS.ANNOTATION.ATTACH,h),h}detach(t){let{cfiRange:e,type:i}=this,s;return t&&("highlight"===i?s=t.unhighlight(e):"underline"===i?s=t.ununderline(e):"mark"===i&&(s=t.unmark(e))),this.mark=void 0,this.emit(EVENTS.ANNOTATION.DETACH,s),s}text(){}}EventEmitter(Annotation.prototype);class Section{constructor(t,e,i){this.item=t,this.idref=t.idref,this.linear="yes"===t.linear,this.properties=t.properties,this.index=t.index,this.url=t.url,this.source=t.source,this.canonical=t.canonical,this.type=t.type,this.next=t.next,this.prev=t.prev,this.cfiBase=t.cfiBase,e?this.hooks=e:(this.hooks={},this.hooks.serialize=new Hook(this),this.hooks.content=new Hook(this)),this.document=void 0,this.contents=void 0,this.output=void 0,this.originalHref=void 0,this.settings=i||{}}load(t){var e=t||this.request||request,i=new defer,s=i.promise;if(this.contents)i.resolve(this.contents);else{let n="application/xhtml+xml"===this.type?"xhtml":"html";e(this.url,n).then((function(t){return this.document=t,this.contents=t.documentElement,this.hooks.content.trigger(this.document,this)}).bind(this)).then((function(){i.resolve(this.contents)}).bind(this)).catch(function(t){i.reject(t)})}return s}base(){return replaceBase(this.document,this)}render(t){var e=new defer,i=e.promise;return this.output,this.load(t).then((function(t){var e,i=("undefined"!=typeof navigator&&navigator.userAgent||"").indexOf("Trident")>=0;"undefined"==typeof XMLSerializer||i||(e=XMLSerializer);var s=new e;return this.output=s.serializeToString(t),this.output}).bind(this)).then((function(){return this.hooks.serialize.trigger(this.output,this)}).bind(this)).then((function(){e.resolve(this.output)}).bind(this)).catch(function(t){e.reject(t)}),i}find(t){var e=this,i=[],s=t.toLowerCase(),n=function(t){for(var n,r,o,a=t.textContent.toLowerCase(),h=e.document.createRange(),l=-1;-1!=r;)-1!=(r=a.indexOf(s,l+1))&&((h=e.document.createRange()).setStart(t,r),h.setEnd(t,r+s.length),n=e.cfiFromRange(h),o=t.textContent.length<150?t.textContent:"..."+(o=t.textContent.substring(r-75,r+75))+"...",i.push({cfi:n,excerpt:o})),l=r};return sprint(e.document,function(t){n(t)}),i}reconcileLayoutSettings(t){var e={layout:t.layout,spread:t.spread,orientation:t.orientation};return this.properties.forEach(function(t){var i,s,n=t.replace("rendition:",""),r=n.indexOf("-");-1!=r&&(i=n.slice(0,r),s=n.slice(r+1),e[i]=s)}),e}cfiFromRange(t){return new EpubCFI(t,this.cfiBase).toString()}cfiFromElement(t){return new EpubCFI(t,this.cfiBase).toString()}unload(){this.document=void 0,this.contents=void 0,this.output=void 0}toObject(){return{idref:this.idref,linear:this.linear?"yes":"no",url:this.url,source:this.source,type:this.type,canonical:this.canonical}}createUrl(t){let e=this.type;return this.render(t).then(t=>new Blob([t],{type:e})).then(t=>this.settings.replacements&&"base64"===this.settings.replacements?blob2base64(t).then(t=>createBase64Url(t,e)):createBlobUrl(t,e)).then(t=>(this.originalHref=this.url,this.url=t,this.unload(),t))}destroy(){this.unload(),this.hooks.serialize.clear(),this.hooks.content.clear(),this.originalHref&&revokeBlobUrl(this.url),this.hooks=void 0,this.idref=void 0,this.linear=void 0,this.properties=void 0,this.index=void 0,this.url=void 0,this.source=void 0,this.next=void 0,this.prev=void 0,this.canonical=void 0}}function createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}var svg={createElement:createElement},events={proxyMouse:proxyMouse};function proxyMouse(t,e){function i(i){for(var s=e.length-1;s>=0;s--){var n=e[s],r=i.clientX,o=i.clientY;if(i.touches&&i.touches.length&&(r=i.touches[0].clientX,o=i.touches[0].clientY),contains(n,t,r,o)){n.dispatchEvent(clone(i));break}}}if("iframe"===t.nodeName||"IFRAME"===t.nodeName)try{this.target=t.contentDocument}catch(s){this.target=t}else this.target=t;for(var n of["mouseup","mousedown","click","touchstart"])this.target.addEventListener(n,t=>i(t),!1)}function clone(t){var e=Object.assign({},t,{bubbles:!1});try{return new MouseEvent(t.type,e)}catch(i){var s=document.createEvent("MouseEvents");return s.initMouseEvent(t.type,!1,e.cancelable,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),s}}function contains(t,e,i,s){var n=e.getBoundingClientRect();function r(t,e,i){var s=t.top-n.top,r=t.left-n.left,o=s+t.height,a=r+t.width;return s<=i&&r<=e&&o>i&&a>e}if(!r(t.getBoundingClientRect(),i,s))return!1;for(var o=t.getClientRects(),a=0,h=o.length;a<h;a++)if(r(o[a],i,s))return!0;return!1}class Pane{constructor(t,e=document.body){this.target=t,this.element=svg.createElement("svg"),this.marks=[],this.element.style.position="absolute",this.element.setAttribute("pointer-events","none"),events.proxyMouse(this.target,this.marks),this.container=e,this.container.appendChild(this.element),this.render()}addMark(t){var e=svg.createElement("g");return this.element.appendChild(e),t.bind(e,this.container),this.marks.push(t),t.render(),t}removeMark(t){var e=this.marks.indexOf(t);if(-1!==e){var i=t.unbind();this.element.removeChild(i),this.marks.splice(e,1)}}render(){for(var t of(setCoords(this.element,coords(this.target,this.container)),this.marks))t.render()}}class Mark{constructor(){this.element=null}bind(t,e){this.element=t,this.container=e}unbind(){var t=this.element;return this.element=null,t}render(){}dispatchEvent(t){this.element&&this.element.dispatchEvent(t)}getBoundingClientRect(){return this.element.getBoundingClientRect()}getClientRects(){for(var t=[],e=this.element.firstChild;e;)t.push(e.getBoundingClientRect()),e=e.nextSibling;return t}filteredRanges(){if(!this.range)return[];let t=Array.from(this.range.getClientRects()),e=t.map(t=>JSON.stringify(t)),i=new Set(e);return Array.from(i).map(t=>JSON.parse(t))}}class Highlight extends Mark{constructor(t,e,i,s){super(),this.range=t,this.className=e,this.data=i||{},this.attributes=s||{}}bind(t,e){for(var i in super.bind(t,e),this.data)this.data.hasOwnProperty(i)&&(this.element.dataset[i]=this.data[i]);for(var i in this.attributes)this.attributes.hasOwnProperty(i)&&this.element.setAttribute(i,this.attributes[i]);this.className&&this.element.classList.add(this.className)}render(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);for(var t=this.element.ownerDocument.createDocumentFragment(),e=this.filteredRanges(),i=this.element.getBoundingClientRect(),s=this.container.getBoundingClientRect(),n=0,r=e.length;n<r;n++){var o=e[n],a=svg.createElement("rect");a.setAttribute("x",o.left-i.left+s.left),a.setAttribute("y",o.top-i.top+s.top),a.setAttribute("height",o.height),a.setAttribute("width",o.width),t.appendChild(a)}this.element.appendChild(t)}}class Underline extends Highlight{constructor(t,e,i,s){super(t,e,i,s)}render(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);for(var t=this.element.ownerDocument.createDocumentFragment(),e=this.filteredRanges(),i=this.element.getBoundingClientRect(),s=this.container.getBoundingClientRect(),n=0,r=e.length;n<r;n++){var o=e[n],a=svg.createElement("rect");a.setAttribute("x",o.left-i.left+s.left),a.setAttribute("y",o.top-i.top+s.top),a.setAttribute("height",o.height),a.setAttribute("width",o.width),a.setAttribute("fill","none");var h=svg.createElement("line");h.setAttribute("x1",o.left-i.left+s.left),h.setAttribute("x2",o.left-i.left+s.left+o.width),h.setAttribute("y1",o.top-i.top+s.top+o.height-1),h.setAttribute("y2",o.top-i.top+s.top+o.height-1),h.setAttribute("stroke-width",1),h.setAttribute("stroke","black"),h.setAttribute("stroke-linecap","square"),t.appendChild(a),t.appendChild(h)}this.element.appendChild(t)}}function coords(t,e){var i=e.getBoundingClientRect(),s=t.getBoundingClientRect();return{top:s.top-i.top,left:s.left-i.left,height:t.scrollHeight,width:t.scrollWidth}}function setCoords(t,e){t.style.setProperty("top",`${e.top}px`,"important"),t.style.setProperty("left",`${e.left}px`,"important"),t.style.setProperty("height",`${e.height}px`,"important"),t.style.setProperty("width",`${e.width}px`,"important")}class IframeView{constructor(t,e){this.settings=extend({ignoreClass:"",axis:void 0,direction:void 0,width:0,height:0,layout:void 0,globalLayoutProperties:{},forceRight:!1,allowScriptedContent:!1,request:void 0,hooks:void 0},e||{}),this.settings.request?this.request=this.settings.request:this.request=request,this.settings.hooks?this.hooks=this.settings.hooks:(this.hooks={},this.hooks.serialize=new Hook(this),this.hooks.document=new Hook(this)),this.id="epubjs-view-"+uuid(),this.section=t,this.index=t.index,this.element=this.container(this.settings.axis),this.added=!1,this.displayed=!1,this.rendered=!1,this.fixedWidth=0,this.fixedHeight=0,this.epubcfi=new EpubCFI,this.layout=this.settings.layout,this.pane=void 0,this.highlights={},this.underlines={},this.marks={}}container(t){var e=document.createElement("div");return e.classList.add("epub-view"),e.style.height="0px",e.style.width="0px",e.style.overflow="hidden",e.style.position="relative",e.style.display="block",t&&"horizontal"==t?e.style.flex="none":e.style.flex="initial",e}create(){return this.iframe||(this.element||(this.element=this.createContainer()),this.iframe=document.createElement("iframe"),this.iframe.id=this.id,this.iframe.scrolling="no",this.iframe.style.overflow="hidden",this.iframe.seamless="seamless",this.iframe.style.border="none",this.iframe.sandbox="allow-same-origin",this.settings.allowScriptedContent&&(this.iframe.sandbox+=" allow-scripts"),this.iframe.setAttribute("enable-annotation","true"),this.resizing=!0,this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.iframe.style.width="0",this.iframe.style.height="0",this._width=0,this._height=0,this.element.setAttribute("ref",this.index),this.element.appendChild(this.iframe),this.added=!0,this.elementBounds=bounds(this.element),"srcdoc"in this.iframe?this.supportsSrcdoc=!0:this.supportsSrcdoc=!1),this.iframe}render(t,e){let i;this.create(),this.size();let s=t||this.request;return i=s(this.section.url).catch(t=>(this.emit(EVENTS.VIEWS.LOAD_ERROR,t),new Promise((e,i)=>{i(t)}))),this.load(i,this.section.encoding).then(()=>{let t=this.contents.writingMode(),e;return e="scrolled"===this.settings.flow?0===t.indexOf("vertical")?"horizontal":"vertical":0===t.indexOf("vertical")?"vertical":"horizontal",0===t.indexOf("vertical")&&"paginated"===this.settings.flow&&(this.layout.delta=this.layout.height),this.setAxis(e),this.emit(EVENTS.VIEWS.AXIS,e),this.setWritingMode(t),this.emit(EVENTS.VIEWS.WRITING_MODE,t),this.layout.format(this.contents,this.section,this.axis),this.addListeners(),new Promise((t,e)=>{this.expand(),this.settings.forceRight&&(this.element.style.marginLeft=this.width()+"px"),t()})},t=>(this.emit(EVENTS.VIEWS.LOAD_ERROR,t),new Promise((e,i)=>{i(t)}))).then(()=>{this.emit(EVENTS.VIEWS.RENDERED,this.section)})}reset(){this.iframe&&(this.iframe.style.width="0",this.iframe.style.height="0",this._width=0,this._height=0,this._textWidth=void 0,this._contentWidth=void 0,this._textHeight=void 0,this._contentHeight=void 0),this._needsReframe=!0}size(t,e){var i=t||this.settings.width,s=e||this.settings.height;"pre-paginated"===this.layout.name?this.lock("both",i,s):"horizontal"===this.settings.axis?this.lock("height",i,s):this.lock("width",i,s),this.settings.width=i,this.settings.height=s}lock(t,e,i){var s,n=borders(this.element);s=this.iframe?borders(this.iframe):{width:0,height:0},"width"==t&&isNumber(e)&&(this.lockedWidth=e-n.width-s.width),"height"==t&&isNumber(i)&&(this.lockedHeight=i-n.height-s.height),"both"===t&&isNumber(e)&&isNumber(i)&&(this.lockedWidth=e-n.width-s.width,this.lockedHeight=i-n.height-s.height),this.displayed&&this.iframe&&this.expand()}expand(t){var e,i=this.lockedWidth,s=this.lockedHeight;this.iframe&&!this._expanding&&(this._expanding=!0,"pre-paginated"===this.layout.name?(i=this.layout.columnWidth,s=this.layout.height):"horizontal"===this.settings.axis?((i=this.contents.textWidth())%this.layout.pageWidth>0&&(i=Math.ceil(i/this.layout.pageWidth)*this.layout.pageWidth),this.settings.forceEvenPages&&(e=i/this.layout.pageWidth,this.layout.divisor>1&&"reflowable"===this.layout.name&&e%2>0&&(i+=this.layout.pageWidth))):"vertical"===this.settings.axis&&(s=this.contents.textHeight(),"paginated"===this.settings.flow&&s%this.layout.height>0&&(s=Math.ceil(s/this.layout.height)*this.layout.height)),(this._needsReframe||i!=this._width||s!=this._height)&&this.reframe(i,s),this._expanding=!1)}reframe(t,e){var i;isNumber(t)&&(this.element.style.width=t+"px",this.iframe.style.width=t+"px",this._width=t),isNumber(e)&&(this.element.style.height=e+"px",this.iframe.style.height=e+"px",this._height=e);let s=this.prevBounds?t-this.prevBounds.width:t,n=this.prevBounds?e-this.prevBounds.height:e;i={width:t,height:e,widthDelta:s,heightDelta:n},this.pane&&this.pane.render(),requestAnimationFrame(()=>{let t;for(let e in this.marks)this.marks.hasOwnProperty(e)&&(t=this.marks[e],this.placeMark(t.element,t.range))}),this.onResize(this,i),this.emit(EVENTS.VIEWS.RESIZED,i),this.prevBounds=i,this.elementBounds=bounds(this.element)}load(t,e="text/html"){var i=new defer,s=i.promise;return this.iframe?(this.iframe.onload=(function(t){this.onLoad(t,i)}).bind(this),t.then(async t=>{await this.hooks.document.trigger(t,this.section,this);let i=serialize(t);await this.hooks.serialize.trigger(i,this),this.blobUrl=createBlobUrl(i,e),this.iframe.src=this.blobUrl}),s):(i.reject(Error("No Iframe Available")),s)}async onLoad(t,e){this.window=this.iframe.contentWindow,this.document=this.iframe.contentDocument,this.contents=new Contents(this.document,this.document.body,this.section.cfiBase,this.section.index),this.rendering=!1,document.fonts&&await document.fonts.ready,this.contents.on(EVENTS.CONTENTS.EXPAND,()=>{this.displayed&&this.iframe&&(this.expand(),this.contents&&this.layout.format(this.contents))}),this.contents.on(EVENTS.CONTENTS.RESIZE,t=>{this.displayed&&this.iframe&&(this.expand(),this.contents&&this.layout.format(this.contents))}),e.resolve(this.contents)}setLayout(t){this.layout=t,this.contents&&(this.layout.format(this.contents),this.expand())}setAxis(t){this.settings.axis=t,"horizontal"==t?this.element.style.flex="none":this.element.style.flex="initial",this.size()}setWritingMode(t){this.writingMode=t}addListeners(){}removeListeners(t){}display(t){var e=new defer;return this.displayed?e.resolve(this):this.render(t).then((function(){this.emit(EVENTS.VIEWS.DISPLAYED,this),this.onDisplayed(this),this.displayed=!0,e.resolve(this)}).bind(this),function(t){e.reject(t,this)}),e.promise}show(){this.element.style.visibility="visible",this.iframe&&(this.iframe.style.visibility="visible",this.iframe.style.transform="translateZ(0)",this.iframe.offsetWidth,this.iframe.style.transform=null),this.emit(EVENTS.VIEWS.SHOWN,this)}hide(){this.element.style.visibility="hidden",this.iframe.style.visibility="hidden",this.stopExpanding=!0,this.emit(EVENTS.VIEWS.HIDDEN,this)}offset(){return{top:this.element.offsetTop,left:this.element.offsetLeft}}width(){return this._width}height(){return this._height}position(){return this.element.getBoundingClientRect()}locationOf(t){this.iframe.getBoundingClientRect();var e=this.contents.locationOf(t,this.settings.ignoreClass);return{left:e.left,top:e.top}}onDisplayed(t){}onResize(t,e){}bounds(t){return(t||!this.elementBounds)&&(this.elementBounds=bounds(this.element)),this.elementBounds}highlight(t,e={},i,s="epubjs-hl",n={}){if(!this.contents)return;let r=Object.assign({fill:"yellow","fill-opacity":"0.3","mix-blend-mode":"multiply"},n),o=this.contents.range(t),a=()=>{this.emit(EVENTS.VIEWS.MARK_CLICKED,t,e)};e.epubcfi=t,this.pane||(this.pane=new Pane(this.iframe,this.element));let h=new Highlight(o,s,e,r),l=this.pane.addMark(h);return this.highlights[t]={mark:l,element:l.element,listeners:[a,i]},l.element.setAttribute("ref",s),l.element.addEventListener("click",a),l.element.addEventListener("touchstart",a),i&&(l.element.addEventListener("click",i),l.element.addEventListener("touchstart",i)),l}underline(t,e={},i,s="epubjs-ul",n={}){if(!this.contents)return;let r=Object.assign({stroke:"black","stroke-opacity":"0.3","mix-blend-mode":"multiply"},n),o=this.contents.range(t),a=()=>{this.emit(EVENTS.VIEWS.MARK_CLICKED,t,e)};e.epubcfi=t,this.pane||(this.pane=new Pane(this.iframe,this.element));let h=new Underline(o,s,e,r),l=this.pane.addMark(h);return this.underlines[t]={mark:l,element:l.element,listeners:[a,i]},l.element.setAttribute("ref",s),l.element.addEventListener("click",a),l.element.addEventListener("touchstart",a),i&&(l.element.addEventListener("click",i),l.element.addEventListener("touchstart",i)),l}mark(t,e={},i){if(!this.contents)return;if(t in this.marks)return this.marks[t];let s=this.contents.range(t);if(!s)return;let n=s.commonAncestorContainer,r=1===n.nodeType?n:n.parentNode,o=i=>{this.emit(EVENTS.VIEWS.MARK_CLICKED,t,e)};s.collapsed&&1===n.nodeType?(s=new Range).selectNodeContents(n):s.collapsed&&(s=new Range).selectNodeContents(r);let a=this.document.createElement("a");return a.setAttribute("ref","epubjs-mk"),a.style.position="absolute",a.dataset.epubcfi=t,e&&Object.keys(e).forEach(t=>{a.dataset[t]=e[t]}),i&&(a.addEventListener("click",i),a.addEventListener("touchstart",i)),a.addEventListener("click",o),a.addEventListener("touchstart",o),this.placeMark(a,s),this.element.appendChild(a),this.marks[t]={element:a,range:s,listeners:[o,i]},r}placeMark(t,e){let i,s,n;if("pre-paginated"===this.layout.name||"horizontal"!==this.settings.axis){let r=e.getBoundingClientRect();i=r.top,s=r.right}else{let o=e.getClientRects(),a;for(var h=0;h!=o.length;h++)a=o[h],(!n||a.left<n)&&(s=Math.ceil((n=a.left)/this.layout.props.pageWidth)*this.layout.props.pageWidth-this.layout.gap/2,i=a.top)}t.style.top=`${i}px`,t.style.left=`${s}px`}unhighlight(t){let e;t in this.highlights&&(e=this.highlights[t],this.pane.removeMark(e.mark),e.listeners.forEach(t=>{t&&(e.element.removeEventListener("click",t),e.element.removeEventListener("touchstart",t))}),delete this.highlights[t])}ununderline(t){let e;t in this.underlines&&(e=this.underlines[t],this.pane.removeMark(e.mark),e.listeners.forEach(t=>{t&&(e.element.removeEventListener("click",t),e.element.removeEventListener("touchstart",t))}),delete this.underlines[t])}unmark(t){let e;t in this.marks&&(e=this.marks[t],this.element.removeChild(e.element),e.listeners.forEach(t=>{t&&(e.element.removeEventListener("click",t),e.element.removeEventListener("touchstart",t))}),delete this.marks[t])}destroy(){for(let t in this.highlights)this.unhighlight(t);for(let e in this.underlines)this.ununderline(e);for(let i in this.marks)this.unmark(i);this.blobUrl&&revokeBlobUrl(this.blobUrl),this.displayed&&(this.displayed=!1,this.removeListeners(),this.contents.destroy(),this.stopExpanding=!0,this.element.removeChild(this.iframe),this.pane&&(this.pane.element.remove(),this.pane=void 0),this.iframe=void 0,this.contents=void 0,this._textWidth=null,this._textHeight=null,this._width=null,this._height=null)}}function scrollType(){var t="reverse",e=createDefiner();return document.body.appendChild(e),e.scrollLeft>0?t="default":"undefined"!=typeof Element&&Element.prototype.scrollIntoView?(e.children[0].children[1].scrollIntoView(),e.scrollLeft<0&&(t="negative")):(e.scrollLeft=1,0===e.scrollLeft&&(t="negative")),document.body.removeChild(e),t}function createDefiner(){var t=document.createElement("div");t.dir="rtl",t.style.position="fixed",t.style.width="1px",t.style.height="1px",t.style.top="0px",t.style.left="0px",t.style.overflow="hidden";var e=document.createElement("div");e.style.width="2px";var i=document.createElement("span");i.style.width="1px",i.style.display="inline-block";var s=document.createElement("span");return s.style.width="1px",s.style.display="inline-block",e.appendChild(i),e.appendChild(s),t.appendChild(e),t}EventEmitter(IframeView.prototype);class Stage{constructor(t){this.settings=t||{},this.id="epubjs-container-"+uuid(),this.container=this.create(this.settings),this.settings.hidden&&(this.wrapper=this.wrap(this.container))}create(t){let e=t.height,i=t.width,s=t.overflow||!1,n=t.axis||"vertical",r=t.direction;extend(this.settings,t),t.height&&isNumber(t.height)&&(e=t.height+"px"),t.width&&isNumber(t.width)&&(i=t.width+"px");let o=document.createElement("div");return o.id=this.id,o.classList.add("epub-container"),o.style.wordSpacing="0",o.style.lineHeight="0",o.style.verticalAlign="top",o.style.position="relative","horizontal"===n&&(o.style.display="flex",o.style.flexDirection="row",o.style.flexWrap="nowrap"),i&&(o.style.width=i),e&&(o.style.height=e),s&&("scroll"===s&&"vertical"===n?(o.style["overflow-y"]=s,o.style["overflow-x"]="hidden"):"scroll"===s&&"horizontal"===n?(o.style["overflow-y"]="hidden",o.style["overflow-x"]=s):o.style.overflow=s),r&&(o.dir=r,o.style.direction=r),r&&this.settings.fullsize&&(document.body.style.direction=r),o}wrap(t){var e=document.createElement("div");return e.style.visibility="hidden",e.style.overflow="hidden",e.style.width="0",e.style.height="0",e.appendChild(t),e}getElement(t){var e;if(isElement(t)?e=t:"string"==typeof t&&(e=document.getElementById(t)),!e)throw Error("Not an Element");return e}attachTo(t){var e,i=this.getElement(t);if(i)return e=this.settings.hidden?this.wrapper:this.container,i.appendChild(e),this.element=i,i}getContainer(){return this.container}onResize(t){isNumber(this.settings.width)&&isNumber(this.settings.height)||(this.resizeFunc=throttle(t,50),window.addEventListener("resize",this.resizeFunc,!1))}onOrientationChange(t){this.orientationChangeFunc=t,window.addEventListener("orientationchange",this.orientationChangeFunc,!1)}size(t,e){var i;let s=t||this.settings.width,n=e||this.settings.height;null===t?(i=this.element.getBoundingClientRect()).width&&(t=Math.floor(i.width),this.container.style.width=t+"px"):isNumber(t)?this.container.style.width=t+"px":this.container.style.width=t,null===e?(i=i||this.element.getBoundingClientRect()).height&&(e=i.height,this.container.style.height=e+"px"):isNumber(e)?this.container.style.height=e+"px":this.container.style.height=e,isNumber(t)||(t=this.container.clientWidth),isNumber(e)||(e=this.container.clientHeight),this.containerStyles=window.getComputedStyle(this.container),this.containerPadding={left:parseFloat(this.containerStyles["padding-left"])||0,right:parseFloat(this.containerStyles["padding-right"])||0,top:parseFloat(this.containerStyles["padding-top"])||0,bottom:parseFloat(this.containerStyles["padding-bottom"])||0};let r=windowBounds(),o=window.getComputedStyle(document.body),a={left:parseFloat(o["padding-left"])||0,right:parseFloat(o["padding-right"])||0,top:parseFloat(o["padding-top"])||0,bottom:parseFloat(o["padding-bottom"])||0};return s||(t=r.width-a.left-a.right),(!this.settings.fullsize||n)&&n||(e=r.height-a.top-a.bottom),{width:t-this.containerPadding.left-this.containerPadding.right,height:e-this.containerPadding.top-this.containerPadding.bottom}}bounds(){let t;return("visible"!==this.container.style.overflow&&(t=this.container&&this.container.getBoundingClientRect()),t&&t.width&&t.height)?t:windowBounds()}getSheet(){var t=document.createElement("style");return t.appendChild(document.createTextNode("")),document.head.appendChild(t),t.sheet}addStyleRules(t,e){var i="#"+this.id+" ",s="";this.sheet||(this.sheet=this.getSheet()),e.forEach(function(t){for(var e in t)t.hasOwnProperty(e)&&(s+=e+":"+t[e]+";")}),this.sheet.insertRule(i+t+" {"+s+"}",0)}axis(t){"horizontal"===t?(this.container.style.display="flex",this.container.style.flexDirection="row",this.container.style.flexWrap="nowrap"):this.container.style.display="block",this.settings.axis=t}direction(t){this.container&&(this.container.dir=t,this.container.style.direction=t),this.settings.fullsize&&(document.body.style.direction=t),this.settings.dir=t}overflow(t){this.container&&("scroll"===t&&"vertical"===this.settings.axis?(this.container.style["overflow-y"]=t,this.container.style["overflow-x"]="hidden"):"scroll"===t&&"horizontal"===this.settings.axis?(this.container.style["overflow-y"]="hidden",this.container.style["overflow-x"]=t):this.container.style.overflow=t),this.settings.overflow=t}destroy(){this.element&&(this.settings.hidden,this.element.contains(this.container)&&this.element.removeChild(this.container),window.removeEventListener("resize",this.resizeFunc),window.removeEventListener("orientationChange",this.orientationChangeFunc))}}class Views{constructor(t){this.container=t,this._views=[],this.length=0,this.hidden=!1}all(){return this._views}first(){return this._views[0]}last(){return this._views[this._views.length-1]}indexOf(t){return this._views.indexOf(t)}slice(){return this._views.slice.apply(this._views,arguments)}get(t){return this._views[t]}append(t){return this._views.push(t),this.container&&this.container.appendChild(t.element),this.length++,t}prepend(t){return this._views.unshift(t),this.container&&this.container.insertBefore(t.element,this.container.firstChild),this.length++,t}insert(t,e){return this._views.splice(e,0,t),this.container&&(e<this.container.children.length?this.container.insertBefore(t.element,this.container.children[e]):this.container.appendChild(t.element)),this.length++,t}remove(t){var e=this._views.indexOf(t);e>-1&&this._views.splice(e,1),this.destroy(t),this.length--}destroy(t){t.displayed&&t.destroy(),this.container&&this.container.removeChild(t.element),t=null}forEach(){return this._views.forEach.apply(this._views,arguments)}clear(){var t,e=this.length;if(this.length){for(var i=0;i<e;i++)t=this._views[i],this.destroy(t);this._views=[],this.length=0}}find(t){for(var e,i=this.length,s=0;s<i;s++)if((e=this._views[s]).displayed&&e.section.index==t.index)return e}displayed(){for(var t,e=[],i=this.length,s=0;s<i;s++)(t=this._views[s]).displayed&&e.push(t);return e}show(){for(var t,e=this.length,i=0;i<e;i++)(t=this._views[i]).displayed&&t.show();this.hidden=!1}hide(){for(var t,e=this.length,i=0;i<e;i++)(t=this._views[i]).displayed&&t.hide();this.hidden=!0}}class DefaultViewManager{constructor(t){this.name="default",this.optsSettings=t.settings,this.View=t.view,this.sections=t.sections,this.request=t.request,this.hooks=t.hooks,this.q=new Queue(this),this.settings=extend(this.settings||{},{infinite:!0,hidden:!1,width:void 0,height:void 0,axis:void 0,writingMode:void 0,flow:"scrolled",ignoreClass:"",fullsize:void 0,allowScriptedContent:!1}),extend(this.settings,t.settings||{}),this.viewSettings={ignoreClass:this.settings.ignoreClass,axis:this.settings.axis,flow:this.settings.flow,layout:this.layout,width:0,height:0,forceEvenPages:!0,allowScriptedContent:this.settings.allowScriptedContent,hooks:this.hooks,request:this.request},this.rendered=!1}render(t,e){let i=t.tagName;void 0===this.settings.fullsize&&i&&("body"==i.toLowerCase()||"html"==i.toLowerCase())&&(this.settings.fullsize=!0),this.settings.fullsize&&(this.settings.overflow="visible",this.overflow=this.settings.overflow),this.settings.size=e,this.settings.rtlScrollType=scrollType(),this.stage=new Stage({width:e.width,height:e.height,overflow:this.overflow,hidden:this.settings.hidden,axis:this.settings.axis,fullsize:this.settings.fullsize,direction:this.settings.direction,scale:this.settings.scale}),this.stage.attachTo(t),this.container=this.stage.getContainer(),this.views=new Views(this.container),this._bounds=this.bounds(),this._stageSize=this.stage.size(),this.viewSettings.width=this._stageSize.width,this.viewSettings.height=this._stageSize.height,this.stage.onResize(this.onResized.bind(this)),this.stage.onOrientationChange(this.onOrientationChange.bind(this)),this.addEventListeners(),this.layout&&this.updateLayout(),this.rendered=!0}addEventListeners(){var t;window.addEventListener("unload",(function(t){this.destroy()}).bind(this)),t=this.settings.fullsize?window:this.container,this._onScroll=this.onScroll.bind(this),t.addEventListener("scroll",this._onScroll)}removeEventListeners(){var t;(t=this.settings.fullsize?window:this.container)&&t.removeEventListener("scroll",this._onScroll),this._onScroll=void 0}destroy(){clearTimeout(this.orientationTimeout),clearTimeout(this.resizeTimeout),clearTimeout(this.afterScrolled),this.clear(),this.removeEventListeners(),this.stage&&this.stage.destroy(),this.rendered=!1}onOrientationChange(t){let{orientation:e}=window;this.optsSettings.resizeOnOrientationChange&&this.resize(),clearTimeout(this.orientationTimeout),this.orientationTimeout=setTimeout((function(){this.orientationTimeout=void 0,this.optsSettings.resizeOnOrientationChange&&this.resize(),this.emit(EVENTS.MANAGERS.ORIENTATION_CHANGE,e)}).bind(this),500)}onResized(t){this.resize()}resize(t,e,i){let s=this.stage.size(t,e);if(this.winBounds=windowBounds(),this.orientationTimeout&&this.winBounds.width===this.winBounds.height){this._stageSize=void 0;return}(!this._stageSize||this._stageSize.width!==s.width||this._stageSize.height!==s.height)&&(this._stageSize=s,this._bounds=this.bounds(),this.clear(),this.viewSettings.width=this._stageSize.width,this.viewSettings.height=this._stageSize.height,this.updateLayout(),this.emit(EVENTS.MANAGERS.RESIZED,{width:this._stageSize.width,height:this._stageSize.height},i))}createView(t,e){return new this.View(t,extend(this.viewSettings,{forceRight:e}))}handleNextPrePaginated(t,e,i){let s;if("pre-paginated"===this.layout.name&&this.layout.divisor>1){if(t||0===e.index)return;if((s=nextSection(e,this.sections))&&!s.properties.includes("page-spread-left"))return i.call(this,s)}}display(t,e){var i=new defer,s=i.promise;(e===t.url||isNumber(e))&&(e=void 0);var n=this.views.find(t);if(n&&t&&"pre-paginated"!==this.layout.name){let r=n.offset();if("ltr"===this.settings.direction)this.scrollTo(r.left,r.top,!0);else{let o=n.width();this.scrollTo(r.left+o,r.top,!0)}if(e){let a=n.locationOf(e),h=n.width();this.moveTo(a,h)}return i.resolve(),s}this.clear();let l=!1;return"pre-paginated"===this.layout.name&&2===this.layout.divisor&&t.properties.includes("page-spread-right")&&(l=!0),this.add(t,l).then((function(t){if(e){let i=t.locationOf(e),s=t.width();this.moveTo(i,s)}}).bind(this),t=>{i.reject(t)}).then((function(){return this.handleNextPrePaginated(l,t,this.add)}).bind(this)).then((function(){this.views.show(),i.resolve()}).bind(this)),s}afterDisplayed(t){this.emit(EVENTS.MANAGERS.ADDED,t)}afterResized(t){this.emit(EVENTS.MANAGERS.RESIZE,t.section)}moveTo(t,e){var i=0,s=0;this.isPaginated?((i=Math.floor(t.left/this.layout.delta)*this.layout.delta)+this.layout.delta>this.container.scrollWidth&&(i=this.container.scrollWidth-this.layout.delta),(s=Math.floor(t.top/this.layout.delta)*this.layout.delta)+this.layout.delta>this.container.scrollHeight&&(s=this.container.scrollHeight-this.layout.delta)):s=t.top,"rtl"===this.settings.direction&&(i+=this.layout.delta,i-=e),this.scrollTo(i,s,!0)}add(t,e){var i=this.createView(t,e);return this.views.append(i),i.onDisplayed=this.afterDisplayed.bind(this),i.onResize=this.afterResized.bind(this),i.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),i.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),i.display(this.request)}append(t,e){var i=this.createView(t,e);return this.views.append(i),i.onDisplayed=this.afterDisplayed.bind(this),i.onResize=this.afterResized.bind(this),i.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),i.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),i.display(this.request)}prepend(t,e){var i=this.createView(t,e);return i.on(EVENTS.VIEWS.RESIZED,t=>{this.counter(t)}),this.views.prepend(i),i.onDisplayed=this.afterDisplayed.bind(this),i.onResize=this.afterResized.bind(this),i.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),i.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),i.display(this.request)}counter(t){"vertical"===this.settings.axis?this.scrollBy(0,t.heightDelta,!0):this.scrollBy(t.widthDelta,0,!0)}next(){var t,e;let i=this.settings.direction;if(this.views.length){if(this.isPaginated&&"horizontal"===this.settings.axis&&(!i||"ltr"===i))this.scrollLeft=this.container.scrollLeft,(e=this.container.scrollLeft+this.container.offsetWidth+this.layout.delta)<=this.container.scrollWidth?this.scrollBy(this.layout.delta,0,!0):t=nextSection(this.views.last().section,this.sections);else if(this.isPaginated&&"horizontal"===this.settings.axis&&"rtl"===i)this.scrollLeft=this.container.scrollLeft,"default"===this.settings.rtlScrollType?(e=this.container.scrollLeft)>0?this.scrollBy(this.layout.delta,0,!0):t=nextSection(this.views.last().section,this.sections):(e=this.container.scrollLeft+-1*this.layout.delta)>-1*this.container.scrollWidth?this.scrollBy(this.layout.delta,0,!0):t=nextSection(this.views.last().section,this.sections);else if(this.isPaginated&&"vertical"===this.settings.axis){this.scrollTop=this.container.scrollTop;this.container.scrollTop+this.container.offsetHeight<this.container.scrollHeight?this.scrollBy(0,this.layout.height,!0):t=nextSection(this.views.last().section,this.sections)}else t=nextSection(this.views.last().section,this.sections);if(t){this.clear(),this.updateLayout();let s=!1;return"pre-paginated"===this.layout.name&&2===this.layout.divisor&&t.properties.includes("page-spread-right")&&(s=!0),this.append(t,s).then((function(){return this.handleNextPrePaginated(s,t,this.append)}).bind(this),t=>t).then((function(){this.isPaginated||"horizontal"!==this.settings.axis||"rtl"!==this.settings.direction||"default"!==this.settings.rtlScrollType||this.scrollTo(this.container.scrollWidth,0,!0),this.views.show()}).bind(this))}}}prev(){var t,e;let i=this.settings.direction;if(this.views.length){if(this.isPaginated&&"horizontal"===this.settings.axis&&(!i||"ltr"===i))this.scrollLeft=this.container.scrollLeft,(e=this.container.scrollLeft)>0?this.scrollBy(-this.layout.delta,0,!0):t=prevSection(this.views.first().section,this.sections);else if(this.isPaginated&&"horizontal"===this.settings.axis&&"rtl"===i)this.scrollLeft=this.container.scrollLeft,"default"===this.settings.rtlScrollType?(e=this.container.scrollLeft+this.container.offsetWidth)<this.container.scrollWidth?this.scrollBy(-this.layout.delta,0,!0):t=prevSection(this.views.first().section,this.sections):(e=this.container.scrollLeft)<0?this.scrollBy(-this.layout.delta,0,!0):t=prevSection(this.views.first().section,this.sections);else if(this.isPaginated&&"vertical"===this.settings.axis){this.scrollTop=this.container.scrollTop;this.container.scrollTop>0?this.scrollBy(0,-this.layout.height,!0):t=prevSection(this.views.first().section,this.sections)}else t=prevSection(this.views.first().section,this.sections);if(t){this.clear(),this.updateLayout();let s=!1;return"pre-paginated"===this.layout.name&&2===this.layout.divisor&&"object"!=typeof t.prev()&&(s=!0),this.prepend(t,s).then((function(){var e;if("pre-paginated"===this.layout.name&&this.layout.divisor>1&&(e=t.prev()))return this.prepend(e)}).bind(this),t=>t).then((function(){this.isPaginated&&"horizontal"===this.settings.axis&&("rtl"===this.settings.direction?"default"===this.settings.rtlScrollType?this.scrollTo(0,0,!0):this.scrollTo(-1*this.container.scrollWidth+this.layout.delta,0,!0):this.scrollTo(this.container.scrollWidth-this.layout.delta,0,!0)),this.views.show()}).bind(this))}}}current(){var t=this.visible();return t.length?t[t.length-1]:null}clear(){this.views&&(this.views.hide(),this.scrollTo(0,0,!0),this.views.clear())}currentLocation(){return this.updateLayout(),this.isPaginated&&"horizontal"===this.settings.axis?this.location=this.paginatedLocation():this.location=this.scrolledLocation(),this.location}scrolledLocation(){let t=this.visible(),e=this.container.getBoundingClientRect(),i=e.height<window.innerHeight?e.height:window.innerHeight,s=e.width<window.innerWidth?e.width:window.innerWidth,n="vertical"===this.settings.axis;this.settings.direction;let r=0;return this.settings.fullsize&&(r=n?window.scrollY:window.scrollX),t.map(t=>{let{index:o,url:a}=t.section,h=t.position(),l=t.width(),d=t.height(),c,u,p,g;n?(u=(c=r+e.top-h.top+0)+i-0,g=this.layout.count(d,i).pages,p=i):(u=(c=r+e.left-h.left+0)+s-0,g=this.layout.count(l,s).pages,p=s);let f=Math.ceil(c/p),m=[],v=Math.ceil(u/p);if("rtl"===this.settings.direction&&!n){let y=f;f=g-v,v=g-y}m=[];for(var E=f;E<=v;E++){let w=E+1;m.push(w)}let b=this.mapping.page(t.contents,t.section.cfiBase,c,u);return{index:o,url:a,pages:m,totalPages:g,mapping:b}})}paginatedLocation(){let t=this.visible(),e=this.container.getBoundingClientRect(),i=0,s=0;return this.settings.fullsize&&(i=window.scrollX),t.map(t=>{let{index:n,url:r}=t.section,o,a=t.position(),h=t.width(),l,d,c;"rtl"===this.settings.direction?(c=Math.min(Math.abs((o=e.right-i)-a.left),this.layout.width)-s,l=(d=a.width-(a.right-o)-s)-c):(o=e.left+i,c=Math.min(a.right-o,this.layout.width)-s,d=(l=o-a.left+s)+c),s+=c;let u=this.mapping.page(t.contents,t.section.canonical,l,d),p=this.layout.count(h).pages,g=Math.floor(l/this.layout.pageWidth),f=[],m=Math.floor(d/this.layout.pageWidth);if(g<0&&(g=0,m+=1),"rtl"===this.settings.direction){let v=g;g=p-m,m=p-v}for(var y=g+1;y<=m;y++){let E=y;f.push(E)}return{index:n,url:r,pages:f,totalPages:p,mapping:u}})}isVisible(t,e,i,s){var n=t.position(),r=s||this.bounds();return"horizontal"===this.settings.axis&&n.right>r.left-e&&n.left<r.right+i||"vertical"===this.settings.axis&&!!(n.bottom>r.top-e)&&!!(n.top<r.bottom+i)}visible(){for(var t,e,i=this.bounds(),s=this.views.displayed(),n=s.length,r=[],o=0;o<n;o++)e=s[o],!0===(t=this.isVisible(e,0,0,i))&&r.push(e);return r}scrollBy(t,e,i){let s="rtl"===this.settings.direction?-1:1;i&&(this.ignore=!0),this.settings.fullsize?window.scrollBy(t*s,e*s):(t&&(this.container.scrollLeft+=t*s),e&&(this.container.scrollTop+=e)),this.scrolled=!0}scrollTo(t,e,i){i&&(this.ignore=!0),this.settings.fullsize?window.scrollTo(t,e):(this.container.scrollLeft=t,this.container.scrollTop=e),this.scrolled=!0}onScroll(){let t,e;this.settings.fullsize?(t=window.scrollY,e=window.scrollX):(t=this.container.scrollTop,e=this.container.scrollLeft),this.scrollTop=t,this.scrollLeft=e,this.ignore?this.ignore=!1:(this.emit(EVENTS.MANAGERS.SCROLL,{top:t,left:e}),clearTimeout(this.afterScrolled),this.afterScrolled=setTimeout((function(){this.emit(EVENTS.MANAGERS.SCROLLED,{top:this.scrollTop,left:this.scrollLeft})}).bind(this),20))}bounds(){var t;return this.stage.bounds()}applyLayout(t){this.layout=t,this.updateLayout(),this.views&&this.views.length>0&&"pre-paginated"===this.layout.name&&this.display(this.views.first().section)}updateLayout(){this.stage&&(this._stageSize=this.stage.size(),this.isPaginated?(this.layout.calculate(this._stageSize.width,this._stageSize.height,this.settings.gap),this.settings.offset=this.layout.delta/this.layout.divisor):this.layout.calculate(this._stageSize.width,this._stageSize.height),this.viewSettings.width=this.layout.width,this.viewSettings.height=this.layout.height,this.setLayout(this.layout))}setLayout(t){this.viewSettings.layout=t,this.mapping=new Mapping(t.props,this.settings.direction,this.settings.axis),this.views&&this.views.forEach(function(e){e&&e.setLayout(t)})}updateWritingMode(t){this.writingMode=t}updateAxis(t,e){(e||t!==this.settings.axis)&&(this.settings.axis=t,this.stage&&this.stage.axis(t),this.viewSettings.axis=t,this.mapping&&(this.mapping=new Mapping(this.layout.props,this.settings.direction,this.settings.axis)),this.layout&&("vertical"===t?this.layout.spread("none"):this.layout.spread(this.layout.settings.spread)))}updateFlow(t,e="auto"){let i="paginated"===t||"auto"===t;this.isPaginated=i,"scrolled-doc"===t||"scrolled-continuous"===t||"scrolled"===t?this.updateAxis("vertical"):this.updateAxis("horizontal"),this.viewSettings.flow=t,this.settings.overflow?this.overflow=this.settings.overflow:this.overflow=i?"hidden":e,this.stage&&this.stage.overflow(this.overflow),this.updateLayout()}getContents(){var t=[];return this.views&&this.views.forEach(function(e){let i=e&&e.contents;i&&t.push(i)}),t}direction(t="ltr"){this.settings.direction=t,this.stage&&this.stage.direction(t),this.viewSettings.direction=t,this.updateLayout()}isRendered(){return this.rendered}scale(t){this.settings.scale=t,this.stage&&this.stage.scale(t)}}EventEmitter(DefaultViewManager.prototype);let PI_D2=Math.PI/2,EASING_EQUATIONS={easeOutSine:function(t){return Math.sin(t*PI_D2)},easeInOutSine:function(t){return -.5*(Math.cos(Math.PI*t)-1)},easeInOutQuint:function(t){return(t/=.5)<1?.5*Math.pow(t,5):.5*(Math.pow(t-2,5)+2)},easeInCubic:function(t){return Math.pow(t,3)}};class Snap{constructor(t,e){this.settings=extend({duration:80,minVelocity:.2,minDistance:10,easing:EASING_EQUATIONS.easeInCubic},e||{}),this.supportsTouch=this.supportsTouch(),this.supportsTouch&&this.setup(t)}setup(t){this.manager=t,this.layout=this.manager.layout,this.fullsize=this.manager.settings.fullsize,this.fullsize?(this.element=this.manager.stage.element,this.scroller=window,this.disableScroll()):(this.element=this.manager.stage.container,this.scroller=this.element,this.element.style.WebkitOverflowScrolling="touch"),this.manager.settings.offset=this.layout.width,this.manager.settings.afterScrolledTimeout=2*this.settings.duration,this.isVertical="vertical"===this.manager.settings.axis,this.manager.isPaginated&&!this.isVertical&&(this.touchCanceler=!1,this.resizeCanceler=!1,this.snapping=!1,this.scrollLeft,this.scrollTop,this.startTouchX=void 0,this.startTouchY=void 0,this.startTime=void 0,this.endTouchX=void 0,this.endTouchY=void 0,this.endTime=void 0,this.addListeners())}supportsTouch(){return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)}disableScroll(){this.element.style.overflow="hidden"}enableScroll(){this.element.style.overflow=""}addListeners(){this._onResize=this.onResize.bind(this),window.addEventListener("resize",this._onResize),this._onScroll=this.onScroll.bind(this),this.scroller.addEventListener("scroll",this._onScroll),this._onTouchStart=this.onTouchStart.bind(this),this.scroller.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this.on("touchstart",this._onTouchStart),this._onTouchMove=this.onTouchMove.bind(this),this.scroller.addEventListener("touchmove",this._onTouchMove,{passive:!0}),this.on("touchmove",this._onTouchMove),this._onTouchEnd=this.onTouchEnd.bind(this),this.scroller.addEventListener("touchend",this._onTouchEnd,{passive:!0}),this.on("touchend",this._onTouchEnd),this._afterDisplayed=this.afterDisplayed.bind(this),this.manager.on(EVENTS.MANAGERS.ADDED,this._afterDisplayed)}removeListeners(){window.removeEventListener("resize",this._onResize),this._onResize=void 0,this.scroller.removeEventListener("scroll",this._onScroll),this._onScroll=void 0,this.scroller.removeEventListener("touchstart",this._onTouchStart,{passive:!0}),this.off("touchstart",this._onTouchStart),this._onTouchStart=void 0,this.scroller.removeEventListener("touchmove",this._onTouchMove,{passive:!0}),this.off("touchmove",this._onTouchMove),this._onTouchMove=void 0,this.scroller.removeEventListener("touchend",this._onTouchEnd,{passive:!0}),this.off("touchend",this._onTouchEnd),this._onTouchEnd=void 0,this.manager.off(EVENTS.MANAGERS.ADDED,this._afterDisplayed),this._afterDisplayed=void 0}afterDisplayed(t){let e=t.contents;["touchstart","touchmove","touchend"].forEach(t=>{e.on(t,t=>this.triggerViewEvent(t,e))})}triggerViewEvent(t,e){this.emit(t.type,t,e)}onScroll(t){this.scrollLeft=this.fullsize?window.scrollX:this.scroller.scrollLeft,this.scrollTop=this.fullsize?window.scrollY:this.scroller.scrollTop}onResize(t){this.resizeCanceler=!0}onTouchStart(t){let{screenX:e,screenY:i}=t.touches[0];this.fullsize&&this.enableScroll(),this.touchCanceler=!0,this.startTouchX||(this.startTouchX=e,this.startTouchY=i,this.startTime=this.now()),this.endTouchX=e,this.endTouchY=i,this.endTime=this.now()}onTouchMove(t){let{screenX:e,screenY:i}=t.touches[0],s=Math.abs(i-this.endTouchY);this.touchCanceler=!0,!this.fullsize&&s<10&&(this.element.scrollLeft-=e-this.endTouchX),this.endTouchX=e,this.endTouchY=i,this.endTime=this.now()}onTouchEnd(t){this.fullsize&&this.disableScroll(),this.touchCanceler=!1;let e=this.wasSwiped();0!==e?this.snap(e):this.snap(),this.startTouchX=void 0,this.startTouchY=void 0,this.startTime=void 0,this.endTouchX=void 0,this.endTouchY=void 0,this.endTime=void 0}wasSwiped(){let t=this.layout.pageWidth*this.layout.divisor,e=this.endTouchX-this.startTouchX,i=Math.abs(e),s=e/(this.endTime-this.startTime),n=this.settings.minVelocity;return i<=this.settings.minDistance||i>=t?0:s>n?-1:s<-n?1:void 0}needsSnap(){let t;return this.scrollLeft%(this.layout.pageWidth*this.layout.divisor)!=0}snap(t=0){let e=this.scrollLeft,i=this.layout.pageWidth*this.layout.divisor,s=Math.round(e/i)*i;return t&&(s+=t*i),this.smoothScrollTo(s)}smoothScrollTo(t){let e=new defer,i=this.scrollLeft,s=this.now(),n=this.settings.duration,r=this.settings.easing;function o(){let a=this.now(),h=Math.min(1,(a-s)/n);if(r(h),this.touchCanceler||this.resizeCanceler){this.resizeCanceler=!1,this.snapping=!1,e.resolve();return}h<1?(window.requestAnimationFrame(o.bind(this)),this.scrollTo(i+(t-i)*h,0)):(this.scrollTo(t,0),this.snapping=!1,e.resolve())}return this.snapping=!0,o.call(this),e.promise}scrollTo(t=0,e=0){this.fullsize?window.scroll(t,e):(this.scroller.scrollLeft=t,this.scroller.scrollTop=e)}now(){return"now"in window.performance?performance.now():new Date().getTime()}destroy(){this.scroller&&(this.fullsize&&this.enableScroll(),this.removeListeners(),this.scroller=void 0)}}EventEmitter(Snap.prototype);class ContinuousViewManager extends DefaultViewManager{constructor(t){super(t),this.name="continuous",this.settings=extend(this.settings||{},{infinite:!0,overflow:void 0,axis:void 0,writingMode:void 0,flow:"scrolled",offset:500,offsetDelta:250,width:void 0,height:void 0,snap:!1,afterScrolledTimeout:10,allowScriptedContent:!1}),extend(this.settings,t.settings||{}),"undefined"!=t.settings.gap&&0===t.settings.gap&&(this.settings.gap=t.settings.gap),this.viewSettings={ignoreClass:this.settings.ignoreClass,axis:this.settings.axis,flow:this.settings.flow,layout:this.layout,width:0,height:0,forceEvenPages:!1,allowScriptedContent:this.settings.allowScriptedContent,hooks:this.hooks,request:this.request},this.scrollTop=0,this.scrollLeft=0}display(t,e){return DefaultViewManager.prototype.display.call(this,t,e).then((function(){return this.fill()}).bind(this))}fill(t){var e=t||new defer;return this.q.enqueue(()=>this.check()).then(t=>{t?this.fill(e):e.resolve()}),e.promise}moveTo(t){var e=0,i=0;this.isPaginated?(e=Math.floor(t.left/this.layout.delta)*this.layout.delta,this.settings.offsetDelta):(i=t.top,t.top,this.settings.offsetDelta),(e>0||i>0)&&this.scrollBy(e,i,!0)}afterResized(t){this.emit(EVENTS.MANAGERS.RESIZE,t.section)}removeShownListeners(t){t.onDisplayed=function(){}}add(t){var e=this.createView(t);return this.views.append(e),e.on(EVENTS.VIEWS.RESIZED,t=>{e.expanded=!0}),e.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),e.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),e.onDisplayed=this.afterDisplayed.bind(this),e.onResize=this.afterResized.bind(this),e.display(this.request)}append(t){var e=this.createView(t);return e.on(EVENTS.VIEWS.RESIZED,t=>{e.expanded=!0}),e.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),e.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),this.views.append(e),e.onDisplayed=this.afterDisplayed.bind(this),e}prepend(t){var e=this.createView(t);return e.on(EVENTS.VIEWS.RESIZED,t=>{this.counter(t),e.expanded=!0}),e.on(EVENTS.VIEWS.AXIS,t=>{this.updateAxis(t)}),e.on(EVENTS.VIEWS.WRITING_MODE,t=>{this.updateWritingMode(t)}),this.views.prepend(e),e.onDisplayed=this.afterDisplayed.bind(this),e}counter(t){"vertical"===this.settings.axis?this.scrollBy(0,t.heightDelta,!0):this.scrollBy(t.widthDelta,0,!0)}update(t){for(var e,i,s=this.bounds(),n=this.views.all(),r=n.length,o=void 0!==t?t:this.settings.offset||0,a=new defer,h=[],l=0;l<r;l++)if(i=n[l],!0===(e=this.isVisible(i,o,o,s))){if(i.displayed)i.show();else{let d=i.display(this.request).then(function(t){t.show()},t=>{i.hide()});h.push(d)}}else this.q.enqueue(i.destroy.bind(i)),clearTimeout(this.trimTimeout),this.trimTimeout=setTimeout((function(){this.q.enqueue(this.trim.bind(this))}).bind(this),250);return h.length?Promise.all(h).catch(t=>{a.reject(t)}):(a.resolve(),a.promise)}check(t,e){var i=new defer,s=[],n="horizontal"===this.settings.axis,r=this.settings.offset||0;t&&n&&(r=t),e&&!n&&(r=e);var o=this._bounds;let a=n?this.scrollLeft:this.scrollTop,h=n?Math.floor(o.width):o.height,l=n?this.container.scrollWidth:this.container.scrollHeight,d=this.writingMode&&0===this.writingMode.indexOf("vertical")?"vertical":"horizontal",c=this.settings.rtlScrollType,u="rtl"===this.settings.direction;this.settings.fullsize?(n&&u&&"negative"===c||!n&&u&&"default"===c)&&(a*=-1):(u&&"default"===c&&"horizontal"===d&&(a=l-h-a),u&&"negative"===c&&"horizontal"===d&&(a*=-1));let p=a+h+r,g=a-r;p>=l&&(()=>{let t=this.views.last(),e=t&&nextSection(t.section,this.sections);e&&s.push(this.append(e))})(),g<0&&(()=>{let t=this.views.first(),e=t&&prevSection(t.section,this.sections);e&&s.push(this.prepend(e))})();let f=s.map(t=>t.display(this.request));return s.length?Promise.all(f).then(()=>this.check()).then(()=>this.update(r),t=>t):(this.q.enqueue((function(){this.update()}).bind(this)),i.resolve(!1),i.promise)}trim(){for(var t=new defer,e=this.views.displayed(),i=e[0],s=e[e.length-1],n=this.views.indexOf(i),r=this.views.indexOf(s),o=this.views.slice(0,n),a=this.views.slice(r+1),h=0;h<o.length-1;h++)this.erase(o[h],o);for(var l=1;l<a.length;l++)this.erase(a[l]);return t.resolve(),t.promise}erase(t,e){this.settings.fullsize?(i=window.scrollY,s=window.scrollX):(i=this.container.scrollTop,s=this.container.scrollLeft);var i,s,n=t.bounds();this.views.remove(t),e&&("vertical"===this.settings.axis?this.scrollTo(0,i-n.height,!0):"rtl"===this.settings.direction?this.settings.fullsize?this.scrollTo(s+Math.floor(n.width),0,!0):this.scrollTo(s,0,!0):this.scrollTo(s-Math.floor(n.width),0,!0))}addEventListeners(t){window.addEventListener("unload",(function(t){this.ignore=!0,this.destroy()}).bind(this)),this.addScrollListeners(),this.isPaginated&&this.settings.snap&&(this.snapper=new Snap(this,this.settings.snap&&"object"==typeof this.settings.snap&&this.settings.snap))}addScrollListeners(){var t;this.tick=requestAnimationFrame$1;let e="rtl"===this.settings.direction&&"default"===this.settings.rtlScrollType?-1:1;this.scrollDeltaVert=0,this.scrollDeltaHorz=0,this.settings.fullsize?(t=window,this.scrollTop=window.scrollY*e,this.scrollLeft=window.scrollX*e):(t=this.container,this.scrollTop=this.container.scrollTop,this.scrollLeft=this.container.scrollLeft),this._onScroll=this.onScroll.bind(this),t.addEventListener("scroll",this._onScroll),this._scrolled=debounce(this.scrolled.bind(this),30),this.didScroll=!1}removeEventListeners(){var t;(t=this.settings.fullsize?window:this.container).removeEventListener("scroll",this._onScroll),this._onScroll=void 0}onScroll(){let t,e,i="rtl"===this.settings.direction&&"default"===this.settings.rtlScrollType?-1:1;this.settings.fullsize?(t=window.scrollY*i,e=window.scrollX*i):(t=this.container.scrollTop,e=this.container.scrollLeft),this.scrollTop=t,this.scrollLeft=e,this.ignore?this.ignore=!1:this._scrolled(),this.scrollDeltaVert+=Math.abs(t-this.prevScrollTop),this.scrollDeltaHorz+=Math.abs(e-this.prevScrollLeft),this.prevScrollTop=t,this.prevScrollLeft=e,clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout((function(){this.scrollDeltaVert=0,this.scrollDeltaHorz=0}).bind(this),150),clearTimeout(this.afterScrolled),this.didScroll=!1}scrolled(){this.q.enqueue((function(){return this.check()}).bind(this)),this.emit(EVENTS.MANAGERS.SCROLL,{top:this.scrollTop,left:this.scrollLeft}),clearTimeout(this.afterScrolled),this.afterScrolled=setTimeout((function(){!(this.snapper&&this.snapper.supportsTouch&&this.snapper.needsSnap())&&this.emit(EVENTS.MANAGERS.SCROLLED,{top:this.scrollTop,left:this.scrollLeft})}).bind(this),this.settings.afterScrolledTimeout)}next(){let t="pre-paginated"===this.layout.props.name&&this.layout.props.spread?2*this.layout.props.delta:this.layout.props.delta;this.views.length&&(this.isPaginated&&"horizontal"===this.settings.axis?this.scrollBy(t,0,!0):this.scrollBy(0,this.layout.height,!0),this.q.enqueue((function(){return this.check()}).bind(this)))}prev(){let t="pre-paginated"===this.layout.props.name&&this.layout.props.spread?2*this.layout.props.delta:this.layout.props.delta;this.views.length&&(this.isPaginated&&"horizontal"===this.settings.axis?this.scrollBy(-t,0,!0):this.scrollBy(0,-this.layout.height,!0),this.q.enqueue((function(){return this.check()}).bind(this)))}updateFlow(t){this.rendered&&this.snapper&&(this.snapper.destroy(),this.snapper=void 0),super.updateFlow(t,"scroll"),this.rendered&&this.isPaginated&&this.settings.snap&&(this.snapper=new Snap(this,this.settings.snap&&"object"==typeof this.settings.snap&&this.settings.snap))}destroy(){super.destroy(),this.snapper&&this.snapper.destroy()}}class Locators{constructor(t){t&&this.unpack(t)}unpack(t){t.locations&&this.unpackLocations(t.locations),t.pagelist&&this.unpackPages(t.pagelist)}unpackLocations(t){if(t){for(let[e,i]of(this.locations=[],t))EpubCFI.prototype.isCfiString(i)?this.locations.push(i):i.cfi&&this.locations.push(i.cfi);this.totalLocations=this.locations.length-1}}unpackPages(t){t&&(this.pages=t,this.pageLocations=[],this.firstPage=parseInt(this.pages[0]),this.lastPage=parseInt(this.pages[this.pages.length-1]),this.totalPages=this.lastPage-this.firstPage,t.forEach(t=>{t.cfi&&this.pageLocations.push(t.cfi)}))}locationFromCfi(t){let e;return(EpubCFI.prototype.isCfiString(t)&&(t=new EpubCFI(t)),0===this.locations.length)?-1:(e=locationOf(t,this.locations,EpubCFI.prototype.compare))>this.totalLocations?this.totalLocations:e}percentageFromCfi(t){if(!this.locations||0===this.locations.length)return null;let e=this.locationFromCfi(t);return this.percentageFromLocation(e)}percentageFromLocation(t){return t&&this.totalLocations?t/this.totalLocations:0}cfiFromLocation(t){var e=-1;return"number"!=typeof t&&(t=parseInt(t)),t>=0&&t<this.locations.length&&(e=this.locations[t]),e}cfiFromPercentage(t){let e;if(t>1&&console.warn("Normalize cfiFromPercentage value to between 0 - 1"),t>=1){let i=new EpubCFI(this.locations[this.totalLocations]);return i.collapse(),i.toString()}return e=Math.ceil(this.totalLocations*t),this.cfiFromLocation(e)}pageFromCfi(t){var e=-1;if(!this.pageLocations||0===this.pageLocations.length)return -1;var i=indexOfSorted(t,this.pageLocations,EpubCFI.prototype.compare);return -1!=i?e=this.pages[i]:void 0!==(e=(i=locationOf(t,this.pageLocations,EpubCFI.prototype.compare))-1>=0?this.pages[i-1]:this.pages[0])||(e=-1),e}cfiFromPage(t){var e=-1;"number"!=typeof t&&(t=parseInt(t));var i=this.pages.indexOf(t);return -1!=i&&(e=this.pageLocations[i]),e}pageFromPercentage(t){return Math.round(this.totalPages*t)}percentageFromPage(t){return Math.round(1e3*((t-this.firstPage)/this.totalPages))/1e3}percentagePageFromCfi(t){var e=this.pageFromCfi(t);return this.percentageFromPage(e)}destroy(){}}EventEmitter(Locators.prototype);class Rendition{constructor(t,e){this.settings=extend(this.settings||{},{width:null,height:null,ignoreClass:"",manager:"default",view:"iframe",flow:null,layout:null,spread:null,minSpreadWidth:800,stylesheet:null,resizeOnOrientationChange:!0,script:null,snap:!1,defaultDirection:"ltr",allowScriptedContent:!1,request:null,canonical:null}),extend(this.settings,e),"object"==typeof this.settings.manager&&(this.manager=this.settings.manager),this.publication=t||new Publication,this.settings.request||void 0===this.publication.request||(this.settings.request=this.publication.request.bind(this.publication)),this.hooks={},this.hooks.display=new Hook(this),this.hooks.document=new Hook(this),this.hooks.serialize=new Hook(this),this.hooks.content=new Hook(this),this.hooks.unloaded=new Hook(this),this.hooks.layout=new Hook(this),this.hooks.render=new Hook(this),this.hooks.show=new Hook(this),this.hooks.content.register(this.handleLinks.bind(this)),this.hooks.content.register(this.passEvents.bind(this)),this.hooks.content.register(this.adjustImages.bind(this)),this.hooks.content.register(this.preloadImages.bind(this)),this.hooks.document.register(this.injectIdentifier.bind(this)),this.hooks.document.register(this.injectBase.bind(this)),this.hooks.document.register(this.injectCanonical.bind(this)),this.settings.stylesheet&&this.hooks.document.register(this.injectStylesheet.bind(this)),this.settings.script&&this.hooks.document.register(this.injectScript.bind(this)),this.themes=new Themes(this),this.annotations=new Annotations(this),this.epubcfi=new EpubCFI,this.q=new Queue(this),this.location=void 0,this.q.enqueue(this.publication.opened),this.started=this.q.enqueue(this.start),this.settings.element&&this.renderTo(this.settings.element)}setManager(t){this.manager=t}requireManager(t){var e;return"string"==typeof t&&"default"===t?DefaultViewManager:"string"==typeof t&&"continuous"===t?ContinuousViewManager:t}requireView(t){var e;return"string"==typeof t&&"iframe"===t?IframeView:t}start(){switch(this.settings.layout||"pre-paginated"!==this.publication.metadata.layout&&"true"!==this.publication.displayOptions.fixedLayout||(this.settings.layout="pre-paginated"),this.publication.metadata.spread){case"none":this.settings.spread="none";break;case"both":this.settings.spread=!0}this.manager||(this.ViewManager=this.requireManager(this.settings.manager),this.View=this.requireView(this.settings.view),this.manager=new this.ViewManager({view:this.View,queue:this.q,hooks:this.hooks,request:this.settings.request,sections:this.publication.sections,settings:this.settings})),this.locators=new Locators(this.publication),this.direction(this.publication.metadata.direction||this.settings.defaultDirection),this.settings.globalLayoutProperties=this.determineLayoutProperties(this.publication.metadata),this.flow(this.settings.globalLayoutProperties.flow),this.layout(this.settings.globalLayoutProperties),this.manager.on(EVENTS.MANAGERS.ADDED,this.afterDisplayed.bind(this)),this.manager.on(EVENTS.MANAGERS.REMOVED,this.afterRemoved.bind(this)),this.manager.on(EVENTS.MANAGERS.RESIZED,this.onResized.bind(this)),this.manager.on(EVENTS.MANAGERS.ORIENTATION_CHANGE,this.onOrientationChange.bind(this)),this.manager.on(EVENTS.MANAGERS.SCROLLED,this.reportLocation.bind(this)),this.emit(EVENTS.RENDITION.STARTED)}renderTo(t){return this.q.enqueue((function(){this.manager.render(t,{width:this.settings.width,height:this.settings.height}),this.emit(EVENTS.RENDITION.ATTACHED)}).bind(this))}attachTo(t){return this.renderTo(t)}display(t){return this.displaying&&this.displaying.resolve(),this.q.enqueue(this._display,t)}_display(t){if(!this.publication)return;let e=new defer,i=e.promise;this.displaying=e,this.locators.locations.length&&isFloat(t)&&(t=this.locators.cfiFromPercentage(parseFloat(t))),void 0===t&&(t=0);let s=this.findResource(t);if(!s)return e.reject(Error("No Section Found")),i;let n=new Section(s);return this.manager.display(n,t).then(()=>{e.resolve(n),this.displaying=void 0,this.emit(EVENTS.RENDITION.DISPLAYED,n),this.reportLocation()},t=>{this.emit(EVENTS.RENDITION.DISPLAY_ERROR,t)}),i}findResource(t){let e;if(this.epubcfi.isCfiString(t)){let i=new EpubCFI(t).base.steps[1];if(i.id)return this.publication.uniqueResources.id(i.id);if(i.index)return this.publication.uniqueResources.find(t=>t.cfiPos===i.index)}return isNumber(t)?this.publication.sections.get(t):this.publication.uniqueResources.get(t)}afterDisplayed(t){t.on(EVENTS.VIEWS.MARK_CLICKED,(e,i)=>this.triggerMarkEvent(e,i,t.contents)),this.hooks.render.trigger(t,this).then(()=>{t.contents?this.hooks.content.trigger(t.contents,t.section,this).then(()=>{this.emit(EVENTS.RENDITION.RENDERED,t.section,t)}):this.emit(EVENTS.RENDITION.RENDERED,t.section,t)})}afterRemoved(t){this.hooks.unloaded.trigger(t,this).then(()=>{this.emit(EVENTS.RENDITION.REMOVED,t.section,t)})}onResized(t,e){this.emit(EVENTS.RENDITION.RESIZED,{width:t.width,height:t.height},e),this.location&&this.location.start&&this.display(e||this.location.start.cfi)}onOrientationChange(t){this.emit(EVENTS.RENDITION.ORIENTATION_CHANGE,t)}moveTo(t){this.manager.moveTo(t)}resize(t,e,i){t&&(this.settings.width=t),e&&(this.settings.height=e),this.manager.resize(t,e,i)}clear(){this.manager.clear()}next(){return this.q.enqueue(this.manager.next.bind(this.manager)).then(this.reportLocation.bind(this))}prev(){return this.q.enqueue(this.manager.prev.bind(this.manager)).then(this.reportLocation.bind(this))}determineLayoutProperties(t){var e,i,s=this.settings.layout||t.layout||"reflowable",n=this.settings.spread||t.spread||"auto",r=this.settings.orientation||t.orientation||"auto",o=this.settings.flow||t.flow||"auto",a=t.viewport||"";return{layout:s,spread:n,orientation:r,flow:o,viewport:a,minSpreadWidth:this.settings.minSpreadWidth||t.minSpreadWidth||800,direction:this.settings.direction||t.direction||"ltr"}}flow(t){var e=t;("scrolled"===t||"scrolled-doc"===t||"scrolled-continuous"===t)&&(e="scrolled"),("auto"===t||"paginated"===t)&&(e="paginated"),this.settings.flow=t,this._layout&&this._layout.flow(e),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this.manager&&this.manager.updateFlow(e),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}layout(t){return t&&(this._layout=new Layout(t),this._layout.spread(t.spread,this.settings.minSpreadWidth),this._layout.on(EVENTS.LAYOUT.UPDATED,(t,e)=>{this.emit(EVENTS.RENDITION.LAYOUT,t,e)})),this.manager&&this._layout&&this.manager.applyLayout(this._layout),this._layout}spread(t,e){this.settings.spread=t,e&&(this.settings.minSpreadWidth=e),this._layout&&this._layout.spread(t,e),this.manager&&this.manager.isRendered()&&this.manager.updateLayout()}direction(t){this.settings.direction=t||"ltr",this.manager&&this.manager.direction(this.settings.direction),this.manager&&this.manager.isRendered()&&this.location&&(this.manager.clear(),this.display(this.location.start.cfi))}reportLocation(){return this.q.enqueue((function t(){requestAnimationFrame((function t(){var e=this.manager.currentLocation();if(e&&e.then&&"function"==typeof e.then)e.then((function(t){let e=this.located(t);e&&e.start&&e.end&&(this.location=e,this.emit(EVENTS.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,url:this.location.start.url,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(EVENTS.RENDITION.RELOCATED,this.location))}).bind(this));else if(e){let i=this.located(e);if(!i||!i.start||!i.end)return;this.location=i,this.emit(EVENTS.RENDITION.LOCATION_CHANGED,{index:this.location.start.index,url:this.location.start.url,start:this.location.start.cfi,end:this.location.end.cfi,percentage:this.location.start.percentage}),this.emit(EVENTS.RENDITION.RELOCATED,this.location)}}).bind(this))}).bind(this))}currentLocation(){var t=this.manager.currentLocation();if(t&&t.then&&"function"==typeof t.then)t.then((function(t){return this.located(t)}).bind(this));else if(t)return this.located(t)}located(t){if(!t.length)return{};let e=t[0],i=t[t.length-1],s={start:{index:e.index,url:e.url,cfi:e.mapping.start,displayed:{page:e.pages[0]||1,total:e.totalPages}},end:{index:i.index,url:i.url,cfi:i.mapping.end,displayed:{page:i.pages[i.pages.length-1]||1,total:i.totalPages}}};if(this.locators.locations.length){let n=this.locators.locationFromCfi(e.mapping.start),r=this.locators.locationFromCfi(i.mapping.end);null!=n&&(s.start.location=n,s.start.percentage=this.locators.percentageFromLocation(n)),null!=r&&(s.end.location=r,s.end.percentage=this.locators.percentageFromLocation(r))}if(this.locators.pages.length){let o=this.locators.pageFromCfi(e.mapping.start),a=this.locators.pageFromCfi(i.mapping.end);-1!=o&&(s.start.page=o),-1!=a&&(s.end.page=a)}return i.index===this.publication.sections.last().index&&s.end.displayed.page>=s.end.displayed.total&&(s.atEnd=!0),e.index===this.publication.sections.first().index&&1===s.start.displayed.page&&(s.atStart=!0),s}destroy(){this.q.clear(),this.q=void 0,this.manager&&this.manager.destroy(),this.publication=void 0,this.hooks.display.clear(),this.hooks.content.clear(),this.hooks.layout.clear(),this.hooks.render.clear(),this.hooks.show.clear(),this.hooks={},this.themes.destroy(),this.themes=void 0,this.epubcfi=void 0}passEvents(t){DOM_EVENTS.forEach(e=>{t.on(e,e=>this.triggerViewEvent(e,t))}),t.on(EVENTS.CONTENTS.SELECTED,e=>this.triggerSelectedEvent(e,t))}triggerViewEvent(t,e){this.emit(t.type,t,e)}triggerSelectedEvent(t,e){this.emit(EVENTS.RENDITION.SELECTED,t,e)}triggerMarkEvent(t,e,i){this.emit(EVENTS.RENDITION.MARK_CLICKED,t,e,i)}getRange(t,e){var i=new EpubCFI(t),s=this.manager.visible().filter(function(t){if(i.spinePos===t.index)return!0});if(s.length)return s[0].contents.range(i,e)}adjustImages(t){if("pre-paginated"===this._layout.name)return new Promise(function(t){t()});let e=t.window.getComputedStyle(t.content,null),i=(t.content.offsetHeight-(parseFloat(e.paddingTop)+parseFloat(e.paddingBottom)))*.95,s=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight);return t.addStylesheetRules({img:{"max-width":(this._layout.columnWidth?this._layout.columnWidth-s+"px":"100%")+"!important","max-height":i+"px!important","object-fit":"contain","page-break-inside":"avoid","break-inside":"avoid","box-sizing":"border-box"},svg:{"max-width":(this._layout.columnWidth?this._layout.columnWidth-s+"px":"100%")+"!important","max-height":i+"px!important","page-break-inside":"avoid","break-inside":"avoid"}}),new Promise(function(t,e){setTimeout(function(){t()},1)})}getContents(){return this.manager?this.manager.getContents():[]}views(){return(this.manager?this.manager.views:void 0)||[]}handleLinks(t,e){t&&t.on(EVENTS.CONTENTS.LINK_CLICKED,t=>{let e=this.publication.resolve(t);this.display(e)})}preloadImages(t){let e=t.document.querySelectorAll("img");for(let i of e)i.loading="lazy"}injectStylesheet(t,e){style.setAttribute("type","text/css"),style.setAttribute("rel","stylesheet"),style.setAttribute("href",this.settings.stylesheet),t.getElementsByTagName("head")[0].appendChild(style)}injectScript(t,e){let i=t.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",this.settings.script),i.textContent=" ",t.getElementsByTagName("head")[0].appendChild(i)}injectIdentifier(t,e){let i=this.publication.metadata.identifier,s=isXMLDocument(t);if(i){let n=s?t.createElementNS(XML_NS,"meta"):t.createElement("meta");n.setAttribute("name","dc.relation.ispartof"),n.setAttribute("content",i),t.getElementsByTagName("head")[0].appendChild(n)}}injectBase(t,e){let i=t.querySelector("head"),s=t.querySelector("base"),n=isXMLDocument(t);s||(s=n?t.createElementNS(XML_NS,"base"):t.createElement("base"),i.insertBefore(s,i.firstChild)),s.setAttribute("href",e.url)}injectCanonical(t,e){let i=this.canonical(e.url),s=t.querySelector("head"),n=t.querySelector("link[rel='canonical']"),r=isXMLDocument(t);n||(n=r?t.createElementNS(XML_NS,"link"):t.createElement("link"),s.appendChild(n)),n.setAttribute("rel","canonical"),n.setAttribute("href",i)}canonical(t){let e=t;return t?e=this.settings.canonical?this.settings.canonical(t):this.publication.resolve(t,!0):""}scale(t){return this.manager&&this.manager.scale(t)}}EventEmitter(Rendition.prototype);class Container{constructor(t){this.packagePath="",this.directory="",this.encoding="",t&&this.parse(t)}parse(t){var e;if(!t)throw Error("Container File Not Found");if(!(e=qs(t,"rootfile")))throw Error("No RootFile Found");this.packagePath=e.getAttribute("full-path"),this.directory=directory(this.packagePath),this.encoding=t.xmlEncoding}destroy(){this.packagePath=void 0,this.directory=void 0,this.encoding=void 0}}class Packaging{constructor(t){this.manifest={},this.navPath="",this.ncxPath="",this.coverPath="",this.spineNodeIndex=0,this.spine=[],this.metadata={},t&&this.parse(t)}parse(t){if(!t)throw Error("Package File Not Found");let e=qs(t,"metadata");if(!e)throw Error("No Metadata Found");let i=qs(t,"manifest");if(!i)throw Error("No Manifest Found");let s=qs(t,"spine");if(!s)throw Error("No Spine Found");return this.metadata=this.parseMetadata(e),this.manifest=this.parseManifest(i),this.navPath=this.findNavPath(i),this.ncxPath=this.findNcxPath(i,s),this.coverPath=this.findCoverPath(t),this.spineNodeIndex=indexOfElementNode(s),this.manifestNodeIndex=indexOfElementNode(i),this.spine=this.parseSpine(s,this.manifest),this.uniqueIdentifier=this.findUniqueIdentifier(t),this.metadata.direction=s.getAttribute("page-progression-direction"),{metadata:this.metadata,spine:this.spine,manifest:this.manifest,navPath:this.navPath,ncxPath:this.ncxPath,coverPath:this.coverPath,spineNodeIndex:this.spineNodeIndex,manifestNodeIndex:this.manifestNodeIndex}}parseMetadata(t){let e={};return e.title=this.getElementText(t,"title"),e.creator=this.getElementText(t,"creator"),e.description=this.getElementText(t,"description"),e.pubdate=this.getElementText(t,"date"),e.publisher=this.getElementText(t,"publisher"),e.identifier=this.getElementText(t,"identifier"),e.language=this.getElementText(t,"language"),e.rights=this.getElementText(t,"rights"),e.modified_date=this.getPropertyText(t,"dcterms:modified"),e.layout=this.getPropertyText(t,"rendition:layout"),e.orientation=this.getPropertyText(t,"rendition:orientation"),e.flow=this.getPropertyText(t,"rendition:flow"),e.viewport=this.getPropertyText(t,"rendition:viewport"),e.media_active_class=this.getPropertyText(t,"media:active-class"),e.spread=this.getPropertyText(t,"rendition:spread"),e}parseManifest(t){var e={},i=qsa(t,"item");return Array.prototype.slice.call(i).forEach(t=>{var i=t.getAttribute("id"),s=t.getAttribute("href")||"",n=t.getAttribute("media-type")||"",r=t.getAttribute("media-overlay")||"",o=t.getAttribute("properties")||"";e[i]={href:s,type:n,overlay:r,properties:o.length?o.split(" "):[]}}),e}parseSpine(t,e){let i=[],s=qsa(t,"itemref"),n=Array.prototype.slice.call(s);return n.forEach((t,e)=>{let s=t.getAttribute("idref"),n=t.getAttribute("properties")||"",r=n.length?n.split(" "):[],o={idref:s,linear:t.getAttribute("linear")||"yes",properties:r,index:e};i.push(o)}),i}findUniqueIdentifier(t){let e=t.documentElement.getAttribute("unique-identifier");if(!e)return"";let i=t.getElementById(e);return i&&"identifier"===i.localName&&"http://purl.org/dc/elements/1.1/"===i.namespaceURI&&i.childNodes.length>0?i.childNodes[0].nodeValue.trim():""}findNavPath(t){let e=qsp(t,"item",{properties:"nav"});return!!e&&e.getAttribute("href")}findNcxPath(t,e){let i=qsp(t,"item",{"media-type":"application/x-dtbncx+xml"});if(!i){let s=e.getAttribute("toc");s&&(i=t.querySelector(`#${s}`))}return!!i&&i.getAttribute("href")}findCoverPath(t){let e=qsp(t,"item",{properties:"cover-image"});if(e)return e.getAttribute("href");let i=qsp(t,"meta",{name:"cover"});if(!i)return!1;{let s=i.getAttribute("content"),n=t.getElementById(s);return n?n.getAttribute("href"):""}}getElementText(t,e){let i=t.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",e);if(!i||0===i.length)return"";let s=i[0];return s.childNodes.length?s.childNodes[0].nodeValue:""}getPropertyText(t,e){let i=qsp(t,"meta",{property:e});return i&&i.childNodes.length?i.childNodes[0].nodeValue:""}destroy(){this.manifest=void 0,this.navPath=void 0,this.ncxPath=void 0,this.coverPath=void 0,this.spineNodeIndex=void 0,this.spine=void 0,this.metadata=void 0}}class Navigation{constructor(t){this.toc=[],this.tocByHref={},this.tocById={},this.landmarks=[],this.landmarksByType={},this.length=0,t&&this.parse(t)}parse(t){let e=t.nodeType,i,s;e&&(i=qs(t,"html"),s=qs(t,"ncx")),e?i?(this.toc=this.parseNav(t),this.landmarks=this.parseLandmarks(t)):s&&(this.toc=this.parseNcx(t)):this.toc=this.load(t),this.length=0,this.unpack(this.toc)}unpack(t){for(var e,i=0;i<t.length;i++)(e=t[i]).href&&(this.tocByHref[e.href]=i),e.id&&(this.tocById[e.id]=i),this.length++,e.children.length&&this.unpack(e.children)}get(t){var e;return t?(0===t.indexOf("#")?e=this.tocById[t.substring(1)]:t in this.tocByHref&&(e=this.tocByHref[t]),this.getByIndex(t,e,this.toc)):this.toc}getByIndex(t,e,i){if(0===i.length)return;let s=i[e];if(s&&(t===s.id||t===s.href))return s;{let n;for(let r=0;r<i.length&&!(n=this.getByIndex(t,e,i[r].subitems));++r);return n}}landmark(t){var e;return t?(e=this.landmarksByType[t],this.landmarks[e]):this.landmarks}parseNav(t){var e=querySelectorByType(t,"nav","toc"),i=[];if(!e)return i;let s=filterChildren(e,"ol",!0);return s?i=this.parseNavList(s):i}parseNavList(t,e){let i=[];if(!t||!t.children)return i;for(let s=0;s<t.children.length;s++){let n=this.navItem(t.children[s],e);n&&i.push(n)}return i}navItem(t,e){let i=t.getAttribute("id")||void 0,s=filterChildren(t,"a",!0)||filterChildren(t,"span",!0);if(!s)return;i||(i="epubjs-autogen-toc-id-"+uuid(),t.setAttribute("id",i));let n=s.getAttribute("href")||"",r=s.textContent||"",o=[],a=filterChildren(t,"ol",!0);return a&&(o=this.parseNavList(a,i)),{id:i,href:n,name:r,children:o,parent:e}}parseLandmarks(t){let e=querySelectorByType(t,"nav","landmarks"),i=e?qsa(e,"li"):[],s=i.length,n,r=[],o;if(!i||0===s)return r;for(n=0;n<s;++n)(o=this.landmarkItem(i[n]))&&(r.push(o),this.landmarksByType[o.type]=n);return r}landmarkItem(t){let e=filterChildren(t,"a",!0);if(!e)return;let i=e.getAttributeNS("http://www.idpf.org/2007/ops","type")||void 0,s=e.getAttribute("href")||"",n=e.textContent||"";return{href:s,name:n,type:i}}parseNcx(t){let e=qsa(t,"navPoint"),i=e.length,s,n={},r=[],o,a;if(!e||0===i)return r;for(s=0;s<i;++s)n[(o=this.ncxItem(e[s])).id]=o,o.parent?(a=n[o.parent]).children.push(o):r.push(o);return r}ncxItem(t){var e,i=t.getAttribute("id")||!1,s=qs(t,"content").getAttribute("src"),n=qs(t,"navLabel"),r=n.textContent?n.textContent:"",o=t.parentNode;return o&&("navPoint"===o.nodeName||"navPoint"===o.nodeName.split(":").slice(-1)[0])&&(e=o.getAttribute("id")),i||(i="epubjs-autogen-toc-id-"+uuid(),t.setAttribute("id",i)),{id:i,href:s,name:r,children:[],parent:e}}forEach(t){return this.toc.forEach(t)}getTocArray(t){return this.toc.map(e=>{let i={href:t?t(e.href):e.href,name:e.name};return e.children.length&&(i.children=e.children),i})}getLandmarksArray(t){return this.landmarks.map(e=>({href:t?t(e.href):e.href,name:e.name,type:e.type}))}}class PageList{constructor(t){this.pages=[],this.locations=[],this.epubcfi=new EpubCFI,this.firstPage=0,this.lastPage=0,this.totalPages=0,this.toc=void 0,this.ncx=void 0,t&&(this.pageList=this.parse(t)),this.pageList&&this.pageList.length&&this.process(this.pageList)}parse(t){var e=qs(t,"html"),i=qs(t,"ncx");return e?this.parseNav(t):i?this.parseNcx(t):void 0}parseNav(t){var e,i,s=querySelectorByType(t,"nav","page-list"),n=s?qsa(s,"li"):[],r=n.length,o=[];if(!n||0===r)return o;for(e=0;e<r;++e)o.push(i=this.item(n[e]));return o}parseNcx(t){var e,i,s,n=[],r=0,o=0;if(!(i=qs(t,"pageList"))||(o=(s=qsa(i,"pageTarget")).length,!s||0===s.length))return n;for(r=0;r<o;++r)n.push(e=this.ncxItem(s[r]));return n}ncxItem(t){var e,i=qs(t,"navLabel"),s=qs(i,"text").textContent;return{href:qs(t,"content").getAttribute("src"),page:parseInt(s,10)}}item(t){var e,i,s,n=qs(t,"a"),r=n.getAttribute("href")||"",o=parseInt(n.textContent||"");return -1!=r.indexOf("epubcfi")?(i=(e=r.split("#"))[0],{cfi:s=e.length>1&&e[1],href:r,packageUrl:i,page:o}):{href:r,page:o}}process(t){t.forEach(function(t){this.pages.push(t.page),t.cfi&&this.locations.push(t.cfi)},this),this.firstPage=parseInt(this.pages[0]),this.lastPage=parseInt(this.pages[this.pages.length-1]),this.totalPages=this.lastPage-this.firstPage}pageFromCfi(t){var e=-1;if(0===this.locations.length)return -1;var i=indexOfSorted$1(t,this.locations,this.epubcfi.compare);return -1!=i?e=this.pages[i]:void 0!==(e=(i=locationOf(t,this.locations,this.epubcfi.compare))-1>=0?this.pages[i-1]:this.pages[0])||(e=-1),e}cfiFromPage(t){var e=-1;"number"!=typeof t&&(t=parseInt(t));var i=this.pages.indexOf(t);return -1!=i&&(e=this.locations[i]),e}pageFromPercentage(t){return Math.round(this.totalPages*t)}percentageFromPage(t){return Math.round(1e3*((t-this.firstPage)/this.totalPages))/1e3}percentageFromCfi(t){var e=this.pageFromCfi(t);return this.percentageFromPage(e)}toArray(){return this.locations}toJSON(){return this.locations}destroy(){this.pages=void 0,this.locations=void 0,this.epubcfi=void 0,this.pageList=void 0,this.toc=void 0,this.ncx=void 0}}class Spine{constructor(t){this.items=void 0,this.manifest=void 0,this.spineNodeIndex=void 0,this.baseUrl=void 0,this.length=0,this.readingOrder=[],this.resources=[],this.epubcfi=new EpubCFI,t&&this.unpack(t)}unpack(t){this.items=t.spine,this.manifest=t.manifest,this.spineNodeIndex=t.spineNodeIndex,this.baseUrl=t.baseUrl||t.basePath||"",this.length=this.items.length,this.items.forEach((t,e)=>{let i=this.manifest[t.idref];t.id=t.idref,t.cfiBase=this.epubcfi.generateChapterComponent(this.spineNodeIndex,t.index,t.idref),t.cfiPos=e,i&&(t.url=i.href,i.properties.length&&t.properties.push.apply(t.properties,i.properties)),"yes"===t.linear?this.readingOrder.push(t):this.resources.push(t)})}destroy(){this.items=void 0,this.manifest=void 0,this.spineNodeIndex=void 0,this.baseUrl=void 0,this.length=void 0,this.epubcfi=void 0,this.readingOrder=void 0}}let CONTAINER_PATH="META-INF/container.xml",IBOOKS_DISPLAY_OPTIONS_PATH="META-INF/com.apple.ibooks.display-options.xml",INPUT_TYPE={EPUB:"epub",OPF:"opf",DIRECTORY:"directory",CONTAINER:"container"};class Epub extends Publication{constructor(t,e){super(),t&&(this.opened=this.open(t))}determineType(t){let e=extension(t);return e?"epub"===e?INPUT_TYPE.EPUB:"opf"===e?INPUT_TYPE.OPF:"xml"===e?INPUT_TYPE.CONTAINER:void 0:INPUT_TYPE.DIRECTORY}async loadContainer(t){let e=await this.load(t);return this.container=new Container(e),this.container}async loadPackaging(t){let e=await this.load(t);return this.packaging=new Packaging(e),this.packaging}async loadNavigation(t){let e=t.navPath||t.ncxPath;if(!e)return{toc:void 0,landmarks:void 0,pageList:void 0,locations:void 0};let i=this.resolve(e),s=await this.load(i,"xml"),n=new Navigation(s,i),r=new PageList(s);return n.toc&&n.toc.length&&(this.contentsUrl=i),n.landmarks&&n.landmarks.length&&(this.landmarksUrl=i),r.pages&&r.pages.length&&(this.pagelistUrl=i),r.locations&&r.locations.length&&(this.locationsUrl=i),{toc:n.toc,landmarks:n.landmarks,pageList:r.pages,locations:r.locations}}async loadDisplayOptions(t){let e;return""===t.metadata.layout&&(e=await this.load("META-INF/com.apple.ibooks.display-options.xml").catch(t=>{})),e}loadSections(t){let e=new Spine(t);return{readingOrder:e.readingOrder,unordered:e.resources}}loadResources(t){let e=[];for(let i in t.manifest){let s=t.manifest[i];"application/xhtml+xml"!==s.type&&"text/html"!==s.type&&(s.url=s.href,e.push(s))}return e}loadMetadata(t){return t.metadata}async unpack(t){this.package=t,this.metadata=this.loadMetadata(t);let e=this.loadResources(t),{readingOrder:i,unordered:s}=this.loadSections(t);this.spine=i,this.resources=[...s,...e];let{toc:n,landmarks:r,pageList:o,locations:a}=await this.loadNavigation(t);if(this.toc=n,this.landmarks=r,this.pagelist=o,this.locations=a,this.displayOptions=await this.loadDisplayOptions(t),t.coverImagePath){let h=this.resources.get(this.resolve(t.coverPath));h&&h.rel.push("cover-image")}return this}async open(t,e){let i=e||this.determineType(t),s;if(i===INPUT_TYPE.EPUB)throw Error("Epub must be unarchived");if(i===INPUT_TYPE.DIRECTORY){let n=await this.loadContainer("META-INF/container.xml");this.url=t+n.packagePath,s=await this.loadPackaging(n.packagePath)}else if(i===INPUT_TYPE.CONTAINER){let r=await this.loadContainer(t),o=resolve(t,"../"+r.packagePath);this.url=o,s=await this.loadPackaging(o)}else this.url=t,s=await this.loadPackaging(t);return this.unpack(s)}get spine(){return this.sections}set spine(t){return this.sections=t}get toc(){return this.navigation}set toc(t){return this.navigation=t}toJSON(){return super.toJSON()}destroy(){}}EventEmitter(Epub.prototype);class Manifest extends Publication{constructor(t,e,i){super(null,e,i),t&&(this.opened=this.open(t))}async unpack(t){for(let[e,i]of Object.entries(t))switch(e){case"readingOrder":this.readingOrder=i;break;case"resources":this.resources=i;break;case"navigation":case"toc":this.navigation=i;break;case"landmarks":this.landmarks=i;break;case"pagelist":this.pagelist=i;break;case"locations":this.locations=i;break;case"cover":this.coverUrl=i;default:this.setMetadata(e,i)}let s=this.contentsUrl;s&&(this.contents=await this.loadNavigation(s,"toc"));let n=this.landmarksUrl;n&&(this.landmarks=await this.loadNavigation(n,"landmarks"));let r=this.pagelistUrl;r&&(this.pagelist=await this.loadNavigation(r,"pagelist"));let o=this.locationsUrl;o&&(this.locations=await this.load(o,"json"))}async open(t){this.url=t;let e=await this.load(t,"json");return this.unpack(e)}async loadNavigation(t,e="toc"){let i=await this.load(t,"html"),s=[],n=createUrl(t);i.querySelector("h1, h2, h3, h4, h5, h6");let r=i.querySelector(`*[role='doc-${e}']`);if(r){let o=r.querySelectorAll("ol > li > a, ul > li > a");for(let a of o)s.push(this.contentsEntry(a,n))}return s}contentsEntry(t,e){let i=t.getAttribute("href"),s=resolve(e,i),n={url:s,name:t.textContent},r=t.querySelectorAll("ol > li > a, ul > li > a");if(r.length)for(let o of(n.children=[],r))n.children.push(this.contentsEntry(o,e));return n}setMetadata(t,e){"readingProgression"===t&&this.metadata.set("direction",e),"url"===t&&(this.url=e),this.metadata.set(t,e)}get readingOrder(){return this.sections}set readingOrder(t){return this.sections=t}get contents(){return this.navigation}set contents(t){return this.navigation=t}}async function generateLocations(t,e={}){let i=new Queue,s=e.chars||150,n=e.request||request,r=e.pause||100,o=[],a=[];for(let[h,l]of(i.pause(),t))o.push(i.enqueue(process,l,s,n,r));i.run();let d=await Promise.all(o);for(let c of d)a.push(...c);return a}function createRange(){return{startContainer:void 0,startOffset:void 0,endContainer:void 0,endOffset:void 0}}async function process(t,e,i,s){let n;return parse(await i(t.url),t.cfiBase)}function parse(t,e,i){let s=[],n,r=qs(t,"body"),o=0,a,h=i;if(sprint(r,function(t){let i=t.length,r,l=0;if(0===t.textContent.trim().length)return!1;for(0==o&&((n=createRange()).startContainer=t,n.startOffset=0),(r=h-o)>i&&(o+=i,l=i);l<i;)if(r=h-o,0===o&&(l+=1,(n=createRange()).startContainer=t,n.startOffset=l),l+r>=i)o+=i-l,l=i;else{l+=r,n.endContainer=t,n.endOffset=l;let d=new EpubCFI(n,e).toString();s.push({cfi:d}),o=0}a=t}),n&&n.startContainer&&a){n.endContainer=a,n.endOffset=a.length;let l=new EpubCFI(n,e).toString();s.push({cfi:l}),o=0}return s}export{Contents,Epub,EpubCFI,Layout,Manifest,Publication,Rendition,core,generateLocations,url};
